<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨ç›¯ç›˜ç³»ç»Ÿ</title>
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- Marked for markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --bg-card-hover: #1f3460;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --accent-blue: #4facfe;
            --accent-purple: #7c3aed;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --border-color: #2d2d5a;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        /* æµ…è‰²ä¸»é¢˜ */
        [data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-card-hover: #f0f4f8;
            --text-primary: #1a202c;
            --text-secondary: #718096;
            --accent-blue: #3182ce;
            --accent-purple: #805ad5;
            --accent-green: #38a169;
            --accent-red: #e53e3e;
            --accent-yellow: #d69e2e;
            --border-color: #e2e8f0;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #3182ce 0%, #00b5d8 100%);
            --gradient-4: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
        }

        [data-theme="light"] .card {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .header {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: rotate(15deg);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--accent-green);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--accent-green);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: var(--bg-secondary);
            padding: 0.5rem;
            border-radius: 12px;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-card);
        }

        .nav-tab.active {
            color: white;
            background: var(--gradient-3);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 8px 32px rgba(79, 172, 254, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Grid Layout */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        @media (max-width: 1200px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
        }

        /* Stat Cards */
        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .stat-card.green::before { background: var(--gradient-4); }
        .stat-card.red::before { background: var(--gradient-2); }
        .stat-card.blue::before { background: var(--gradient-3); }
        .stat-card.purple::before { background: var(--gradient-1); }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-value.green { color: var(--accent-green); }
        .stat-value.red { color: var(--accent-red); }
        .stat-value.blue { color: var(--accent-blue); }

        .stat-change {
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        /* Stock Table */
        .stock-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stock-table th,
        .stock-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .stock-table th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stock-table tr:hover {
            background: var(--bg-card-hover);
        }

        .stock-name {
            font-weight: 600;
        }

        .stock-code {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .price-up { color: var(--accent-red); }
        .price-down { color: var(--accent-green); }
        .price-flat { color: var(--text-secondary); }

        .change-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .change-badge.up {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
        }

        .change-badge.down {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-green);
        }

        .change-badge.flat {
            background: rgba(160, 160, 160, 0.1);
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--gradient-3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        .btn-danger:hover {
            background: var(--accent-red);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            justify-content: center;
        }

        /* Input */
        .input-group {
            display: flex;
            gap: 0.5rem;
        }

        .input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .input::placeholder {
            color: var(--text-secondary);
        }

        /* Search Results */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }

        .search-results.show {
            display: block;
        }

        .search-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .search-item:last-child {
            border-bottom: none;
        }

        .search-item:hover {
            background: var(--bg-card-hover);
        }

        /* Charts */
        .chart-container {
            width: 100%;
            height: 300px;
        }

        /* è‚¡æŒ‡Grid */
        .indices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .index-item {
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .index-item:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .index-name {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .index-price {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .index-change {
            font-size: 0.9rem;
        }

        /* å•†å“åˆ—è¡¨ */
        .commodity-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .commodity-item:last-child {
            border-bottom: none;
        }

        .commodity-name {
            font-size: 1rem;
            font-weight: 500;
        }

        .commodity-code {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .commodity-price {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .commodity-unit {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* ç›¸å…³æ€§åˆ†æ */
        .correlation-matrix {
            display: grid;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .correlation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .correlation-value {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .correlation-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }

        .update-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .chart-container-lg {
            height: 400px;
        }

        /* AI Analysis */
        .ai-panel {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .ai-header {
            padding: 1rem 1.5rem;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .ai-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .ai-content {
            padding: 1.5rem;
            line-height: 1.8;
            color: var(--text-secondary);
        }

        .ai-content p {
            margin-bottom: 1rem;
        }

        .ai-content strong {
            color: var(--text-primary);
        }

        .ai-content ul, .ai-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .ai-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.75rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* News List */
        .news-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .news-item {
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .news-item:hover {
            border-color: var(--accent-blue);
        }

        .news-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .news-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Alert List */
        .alert-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .alert-icon.up {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
        }

        .alert-icon.down {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-green);
        }

        .alert-info {
            flex: 1;
        }

        .alert-message {
            font-weight: 500;
        }

        .alert-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Technical Signals */
        .signals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .signal-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .signal-item.signal-buy {
            border-color: var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .signal-item.signal-sell {
            border-color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
        }

        .signal-item.signal-warning {
            border-color: var(--accent-yellow);
            background: rgba(245, 158, 11, 0.1);
        }

        .signal-icon {
            font-size: 1.2rem;
        }

        .signal-indicator {
            font-weight: 600;
            color: var(--text-primary);
        }

        .signal-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .indicator-value-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .indicator-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .indicator-num {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .indicator-num.green {
            color: var(--accent-green);
        }

        .indicator-num.red {
            color: var(--accent-red);
        }

        .overall-signal {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        /* Groups */
        .group-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem 0;
        }

        .group-tab {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .group-tab:hover {
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }

        .group-tab.active {
            background: var(--gradient-3);
            color: white;
            border-color: transparent;
        }

        .group-tab .count {
            margin-left: 0.25rem;
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Portfolio */
        .trade-form {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
        }

        .position-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .position-item:hover {
            background: var(--bg-card-hover);
        }

        .position-item:last-child {
            border-bottom: none;
        }

        .position-info {
            flex: 1;
            min-width: 0;
        }

        .position-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .position-code {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .position-detail {
            text-align: right;
            margin-right: 1rem;
        }

        .position-quantity {
            font-size: 0.85rem;
        }

        .position-cost {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .position-profit {
            text-align: right;
            min-width: 100px;
        }

        .position-profit-amount {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .position-profit-percent {
            font-size: 0.8rem;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-type {
            width: 50px;
            font-weight: 600;
        }

        .transaction-type.buy {
            color: var(--accent-green);
        }

        .transaction-type.sell {
            color: var(--accent-red);
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-time {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .transaction-amount {
            text-align: right;
            min-width: 100px;
        }

        /* Sector List */
        .sector-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .sector-item {
            display: flex;
            align-items: center;
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .sector-item:hover {
            background: var(--bg-card-hover);
        }

        .sector-item:last-child {
            border-bottom: none;
        }

        .sector-rank {
            width: 20px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-right: 0.5rem;
        }

        .sector-info {
            flex: 1;
            min-width: 0;
        }

        .sector-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .sector-stats {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .sector-change {
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 70px;
            text-align: right;
        }

        .sector-flow {
            font-size: 0.8rem;
            min-width: 80px;
            text-align: right;
        }

        .sector-overview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .sector-overview-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
        }

        .sector-overview-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .sector-overview-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .sector-stat {
            text-align: center;
        }

        .sector-stat-value {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .sector-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .sector-top-list {
            font-size: 0.85rem;
        }

        .sector-top-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }

        /* North Holdings */
        .holdings-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .holding-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .holding-item:hover {
            background: var(--bg-card-hover);
        }

        .holding-item:last-child {
            border-bottom: none;
        }

        .holding-rank {
            width: 24px;
            height: 24px;
            background: var(--gradient-3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 0.75rem;
        }

        .holding-info {
            flex: 1;
            min-width: 0;
        }

        .holding-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .holding-code {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .holding-stats {
            text-align: right;
            margin-right: 1rem;
        }

        .holding-ratio {
            font-size: 0.8rem;
            color: var(--accent-blue);
        }

        .holding-cap {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .holding-change {
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 60px;
            text-align: right;
        }

        /* Utilities */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 1rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-blue);
        }

        /* Data Table */
        .data-table {
            border-collapse: collapse;
            width: 100%;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
        }

        .data-table td {
            color: var(--text-primary);
        }

        .data-table tr:hover {
            background: var(--bg-card-hover);
        }

        /* Ratio Item */
        .ratio-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .ratio-item:last-child {
            border-bottom: none;
        }

        .ratio-value {
            font-weight: 600;
        }

        /* Text Color */
        .text-green {
            color: var(--accent-green) !important;
        }

        .text-red {
            color: var(--accent-red) !important;
        }

        /* Grid 5 */
        .grid-5 {
            grid-template-columns: repeat(5, 1fr);
        }

        @media (max-width: 1200px) {
            .grid-5 {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .grid-5 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">ğŸ“ˆ</div>
            <span class="logo-text">è‚¡ç¥¨ç›¯ç›˜ç³»ç»Ÿ</span>
        </div>
        <div class="header-actions">
            <div class="status-badge">
                <span class="status-dot"></span>
                <span id="connectionStatus">è¿æ¥ä¸­...</span>
            </div>
            <button class="btn btn-secondary theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                <span id="themeIcon">ğŸŒ™</span>
            </button>
            <button class="btn btn-primary" onclick="refreshAll()">
                ğŸ”„ åˆ·æ–°æ•°æ®
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">ğŸ“Š æ¦‚è§ˆ</button>
            <button class="nav-tab" data-tab="watchlist">â­ å…³æ³¨åˆ—è¡¨</button>
            <button class="nav-tab" data-tab="analysis">ğŸ¤– AI åˆ†æ</button>
            <button class="nav-tab" data-tab="correlation">ğŸ“ˆ ç›¸å…³æ€§åˆ†æ</button>
            <button class="nav-tab" data-tab="sentiment">ğŸ“¢ èˆ†æƒ…æŒ‡æ•°</button>
            <button class="nav-tab" data-tab="technical">ğŸ“‰ æŠ€æœ¯æŒ‡æ ‡</button>
            <button class="nav-tab" data-tab="sectors">ğŸ­ æ¿å—åˆ†æ</button>
            <button class="nav-tab" data-tab="finance">ğŸ“‘ è´¢æŠ¥åˆ†æ</button>
            <button class="nav-tab" data-tab="screener">ğŸ” é€‰è‚¡å™¨</button>
            <button class="nav-tab" data-tab="us_stock">ğŸ‡ºğŸ‡¸ ç¾è‚¡</button>
            <button class="nav-tab" data-tab="portfolio">ğŸ’¼ æˆ‘çš„æŒä»“</button>
            <button class="nav-tab" data-tab="alerts">ğŸ”” æé†’</button>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <!-- ä¸»è¦è‚¡æŒ‡ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“Š ä¸»è¦è‚¡æŒ‡</h3>
                    <span class="update-time" id="indicesUpdateTime">--:--</span>
                </div>
                <div class="indices-grid" id="indicesGrid">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- å¤§å®—å•†å“ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ† å¤§å®—å•†å“</h3>
                    <span class="update-time" id="commoditiesUpdateTime">--:--</span>
                </div>
                <div id="commoditiesList">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- Market Overview Stats -->
            <div class="grid grid-4 mb-3">
                <div class="stat-card green">
                    <div class="stat-label">ä¸Šæ¶¨å®¶æ•°</div>
                    <div class="stat-value green" id="upCount">--</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-label">ä¸‹è·Œå®¶æ•°</div>
                    <div class="stat-value red" id="downCount">--</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">æ¶¨åœ / è·Œåœ</div>
                    <div class="stat-value blue" id="limitCount">-- / --</div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-label">åŒ—å‘èµ„é‡‘å‡€æµå…¥</div>
                    <div class="stat-value" id="northFlow">--</div>
                    <div class="stat-change" id="northFlowUnit">äº¿å…ƒ</div>
                </div>
            </div>

            <div class="grid grid-2 mb-3">
                <!-- Market Sentiment Chart -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">å¸‚åœºæƒ…ç»ª</h3>
                    </div>
                    <div id="sentimentChart" class="chart-container"></div>
                </div>

                <!-- North Flow Chart -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">åŒ—å‘èµ„é‡‘èµ°åŠ¿</h3>
                        <button class="btn btn-sm btn-secondary" onclick="loadNorthFlowChart()">åˆ·æ–°</button>
                    </div>
                    <div id="northFlowChart" class="chart-container"></div>
                    <div id="northFlowInfo" style="padding: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);"></div>
                </div>
            </div>

            <div class="grid grid-2">
                <!-- Quick Watch List -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">å…³æ³¨åˆ—è¡¨é€Ÿè§ˆ</h3>
                        <button class="btn btn-sm btn-secondary" onclick="switchTab('watchlist')">æŸ¥çœ‹å…¨éƒ¨</button>
                    </div>
                    <div id="quickWatchList">
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“‹</div>
                            <p>æš‚æ— å…³æ³¨è‚¡ç¥¨</p>
                        </div>
                    </div>
                </div>

                <!-- North Flow Holdings -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">åŒ—å‘èµ„é‡‘é‡ä»“è‚¡</h3>
                        <button class="btn btn-sm btn-secondary" onclick="loadNorthHoldings()">åˆ·æ–°</button>
                    </div>
                    <div id="northHoldingsList">
                        <div class="empty-state" style="padding: 1rem;">
                            <p>ç‚¹å‡»åˆ·æ–°åŠ è½½æ•°æ®</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é¾™è™æ¦œé€Ÿè§ˆ -->
            <div class="card mt-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ‰ é¾™è™æ¦œé€Ÿè§ˆ</h3>
                    <button class="btn btn-sm btn-secondary" onclick="loadLhbQuick()">åˆ·æ–°</button>
                </div>
                <div id="lhbQuickList">
                    <div class="empty-state" style="padding: 1rem;">
                        <p>ç‚¹å‡»åˆ·æ–°åŠ è½½é¾™è™æ¦œæ•°æ®</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Watch List Tab -->
        <div id="watchlist" class="tab-content">
            <!-- Add Stock -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">æ·»åŠ è‚¡ç¥¨</h3>
                </div>
                <div class="input-group" style="position: relative;">
                    <input type="text" class="input" id="searchInput" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°æœç´¢..." autocomplete="off">
                    <button class="btn btn-primary" onclick="searchStock()">ğŸ” æœç´¢</button>
                    <div class="search-results" id="searchResults"></div>
                </div>
            </div>

            <!-- åˆ†ç»„ç®¡ç† -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“ åˆ†ç»„ç®¡ç†</h3>
                    <div class="flex gap-1">
                        <input type="text" class="input" id="newGroupName" placeholder="æ–°åˆ†ç»„åç§°" style="width: 150px;">
                        <button class="btn btn-sm btn-primary" onclick="createGroup()">åˆ›å»ºåˆ†ç»„</button>
                    </div>
                </div>
                <div id="groupTabs" class="group-tabs">
                    <button class="group-tab active" data-group="all" onclick="selectGroup('all')">å…¨éƒ¨</button>
                    <button class="group-tab" data-group="default" onclick="selectGroup('default')">é»˜è®¤</button>
                </div>
            </div>

            <!-- Watch List Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">æˆ‘çš„å…³æ³¨ <span id="currentGroupLabel" style="font-size: 0.85rem; color: var(--text-secondary);"></span></h3>
                    <div class="flex gap-1">
                        <button class="btn btn-sm btn-secondary" onclick="loadWatchListQuotes()">ğŸ”„ åˆ·æ–°è¡Œæƒ…</button>
                        <button class="btn btn-sm btn-secondary" onclick="exportWatchlist()">ğŸ“¥ å¯¼å‡ºCSV</button>
                    </div>
                </div>
                <div id="watchListTable">
                    <div class="empty-state">
                        <div class="empty-icon">â­</div>
                        <p>æš‚æ— å…³æ³¨è‚¡ç¥¨ï¼Œè¯·æœç´¢å¹¶æ·»åŠ </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Analysis Tab -->
        <div id="analysis" class="tab-content">
            <div class="grid grid-2">
                <!-- Stock Analysis -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">è‚¡ç¥¨ AI åˆ†æ</h3>
                    </div>
                    <div class="input-group mb-2">
                        <input type="text" class="input" id="analysisStockCode" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œå¦‚ 600519">
                        <button class="btn btn-primary" onclick="analyzeStock()">ğŸ¤– åˆ†æ</button>
                    </div>
                    <div class="ai-panel">
                        <div class="ai-header">
                            <span>ğŸ¤–</span>
                            <h3>AI åˆ†æç»“æœ</h3>
                        </div>
                        <div class="ai-content" id="stockAnalysisResult">
                            <p>è¾“å…¥è‚¡ç¥¨ä»£ç åç‚¹å‡»åˆ†ææŒ‰é’®è·å– AI åˆ†æ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Daily Summary -->
            <div class="card mt-2">
                <div class="card-header">
                    <h3 class="card-title">æ¯æ—¥ç›¯ç›˜æ€»ç»“</h3>
                    <button class="btn btn-primary" onclick="generateDailySummary()">ğŸ“ ç”Ÿæˆæ€»ç»“</button>
                </div>
                <div class="ai-panel">
                    <div class="ai-header">
                        <span>ğŸ“‹</span>
                        <h3>ä»Šæ—¥æ€»ç»“</h3>
                    </div>
                    <div class="ai-content" id="dailySummaryResult">
                        <p>ç‚¹å‡»ç”Ÿæˆæ€»ç»“æŒ‰é’®ï¼ŒAI å°†æ ¹æ®æ‚¨çš„å…³æ³¨åˆ—è¡¨ç”Ÿæˆæ¯æ—¥ç›¯ç›˜æ€»ç»“</p>
                    </div>
                </div>
            </div>

            <!-- News Analysis -->
            <div class="card mt-2">
                <div class="card-header">
                    <h3 class="card-title">è‚¡ç¥¨æ–°é—»</h3>
                </div>
                <div class="input-group mb-2">
                    <input type="text" class="input" id="newsStockCode" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç è·å–ç›¸å…³æ–°é—»">
                    <button class="btn btn-primary" onclick="loadStockNews()">ğŸ“° è·å–æ–°é—»</button>
                </div>
                <div id="newsList" class="news-list">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“°</div>
                        <p>è¾“å…¥è‚¡ç¥¨ä»£ç è·å–ç›¸å…³æ–°é—»</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Correlation Analysis Tab -->
        <div id="correlation" class="tab-content">
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“Š åŒè‚¡/å®è§‚ç›¸å…³æ€§åˆ†æ</h3>
                </div>
                
                <!-- Asset 1 Selection -->
                <div class="grid grid-2 mb-3">
                    <div class="form-group">
                        <label class="form-label">èµ„äº§ 1 (è‚¡ç¥¨/æŒ‡æ•°/å®è§‚)</label>
                        <input type="text" class="input" id="corrCode1" placeholder="è¾“å…¥ä»£ç ï¼Œå¦‚ 600519 æˆ– MACRO_CPI">
                    </div>
                    <div>
                        <label class="form-label">èµ„äº§ 1 å¿«æ·é€‰æ‹©</label>
                        <div class="flex gap-1" style="margin-bottom: 0.5rem;">
                            <select class="input" id="watchListSelect1" onchange="fillCorrelationInput1(this.value)" style="flex: 1;">
                                <option value="">-- ä»å…³æ³¨åˆ—è¡¨é€‰æ‹© --</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <select class="input" onchange="if(this.value) fillCorrelationInput1(this.value); this.value='';" style="font-size: 0.85rem;">
                                <option value="">å®è§‚æ•°æ®</option>
                                <option value="MACRO_CPI">CPI (æ¶ˆè´¹ä»·æ ¼æŒ‡æ•°)</option>
                                <option value="MACRO_PPI">PPI (ç”Ÿäº§è€…ä»·æ ¼)</option>
                                <option value="MACRO_PMI">PMI (åˆ¶é€ ä¸š)</option>
                                <option value="MACRO_PMI_NON">éåˆ¶é€ ä¸šPMI</option>
                                <option value="MACRO_GDP">GDP</option>
                                <option value="MACRO_M1">M1 (è´§å¸ä¾›åº”)</option>
                                <option value="MACRO_M2">M2 (è´§å¸ä¾›åº”)</option>
                                <option value="MACRO_INDUSTRIAL">å·¥ä¸šå¢åŠ å€¼</option>
                                <option value="MACRO_FIXED_INVESTMENT">å›ºå®šèµ„äº§æŠ•èµ„</option>
                                <option value="MACRO_RETAIL">ç¤¾æ¶ˆé›¶å”®æ€»é¢</option>
                                <option value="MACRO_FINANCING">ç¤¾ä¼šèèµ„è§„æ¨¡</option>
                                <option value="MACRO_EXCHANGE">ç¾å…ƒæ±‡ç‡</option>
                                <option value="MACRO_UNEMPLOYMENT">å¤±ä¸šç‡</option>
                                <option value="MACRO_TRADE">è¿›å‡ºå£æ€»é¢</option>
                            </select>
                            <select class="input" onchange="if(this.value) fillCorrelationInput1(this.value); this.value='';" style="font-size: 0.85rem;">
                                <option value="">è‚¡æŒ‡</option>
                                <option value="000001">ä¸Šè¯æŒ‡æ•°</option>
                                <option value="000300">æ²ªæ·±300</option>
                                <option value="000016">ä¸Šè¯50</option>
                                <option value="000688">ç§‘åˆ›50</option>
                                <option value="399001">æ·±è¯æˆæŒ‡</option>
                                <option value="399006">åˆ›ä¸šæ¿æŒ‡</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Asset 2 Selection -->
                <div class="grid grid-2 mb-3">
                    <div class="form-group">
                        <label class="form-label">èµ„äº§ 2 (è‚¡ç¥¨/æŒ‡æ•°/å®è§‚)</label>
                        <input type="text" class="input" id="corrCode2" placeholder="è¾“å…¥ä»£ç ï¼Œå¦‚ 000858">
                    </div>
                    <div>
                        <label class="form-label">èµ„äº§ 2 å¿«æ·é€‰æ‹©</label>
                        <div class="flex gap-1" style="margin-bottom: 0.5rem;">
                            <select class="input" id="watchListSelect2" onchange="fillCorrelationInput2(this.value)" style="flex: 1;">
                                <option value="">-- ä»å…³æ³¨åˆ—è¡¨é€‰æ‹© --</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <select class="input" onchange="if(this.value) fillCorrelationInput2(this.value); this.value='';" style="font-size: 0.85rem;">
                                <option value="">å®è§‚æ•°æ®</option>
                                <option value="MACRO_CPI">CPI (æ¶ˆè´¹ä»·æ ¼æŒ‡æ•°)</option>
                                <option value="MACRO_PPI">PPI (ç”Ÿäº§è€…ä»·æ ¼)</option>
                                <option value="MACRO_PMI">PMI (åˆ¶é€ ä¸š)</option>
                                <option value="MACRO_PMI_NON">éåˆ¶é€ ä¸šPMI</option>
                                <option value="MACRO_GDP">GDP</option>
                                <option value="MACRO_M1">M1 (è´§å¸ä¾›åº”)</option>
                                <option value="MACRO_M2">M2 (è´§å¸ä¾›åº”)</option>
                                <option value="MACRO_INDUSTRIAL">å·¥ä¸šå¢åŠ å€¼</option>
                                <option value="MACRO_FIXED_INVESTMENT">å›ºå®šèµ„äº§æŠ•èµ„</option>
                                <option value="MACRO_RETAIL">ç¤¾æ¶ˆé›¶å”®æ€»é¢</option>
                                <option value="MACRO_FINANCING">ç¤¾ä¼šèèµ„è§„æ¨¡</option>
                                <option value="MACRO_EXCHANGE">ç¾å…ƒæ±‡ç‡</option>
                                <option value="MACRO_UNEMPLOYMENT">å¤±ä¸šç‡</option>
                                <option value="MACRO_TRADE">è¿›å‡ºå£æ€»é¢</option>
                            </select>
                            <select class="input" onchange="if(this.value) fillCorrelationInput2(this.value); this.value='';" style="font-size: 0.85rem;">
                                <option value="">è‚¡æŒ‡</option>
                                <option value="000001">ä¸Šè¯æŒ‡æ•°</option>
                                <option value="000300">æ²ªæ·±300</option>
                                <option value="000016">ä¸Šè¯50</option>
                                <option value="000688">ç§‘åˆ›50</option>
                                <option value="399001">æ·±è¯æˆæŒ‡</option>
                                <option value="399006">åˆ›ä¸šæ¿æŒ‡</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label class="form-label">åˆ†æå‘¨æœŸ</label>
                    <select class="input" id="corrDays">
                        <option value="60">60å¤© (çº¦2ä¸ªæœˆ)</option>
                        <option value="120">120å¤© (çº¦åŠå¹´)</option>
                        <option value="250" selected>250å¤© (çº¦1å¹´)</option>
                        <option value="500">500å¤© (çº¦2å¹´)</option>
                        <option value="750">750å¤© (çº¦3å¹´)</option>
                        <option value="1250">1250å¤© (çº¦5å¹´)</option>
                        <option value="2500">2500å¤© (çº¦10å¹´)</option>
                        <option value="5000">5000å¤© (çº¦20å¹´)</option>
                    </select>
                </div>

                <div class="form-group mb-3">
                    <label class="form-label">åˆ†ææŒ‡æ ‡ (è‚¡ç¥¨ vs è‚¡ç¥¨)</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" value="turnover_rate" class="corr-indicator" checked> æ¢æ‰‹ç‡
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" value="amplitude" class="corr-indicator" checked> æŒ¯å¹…
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" value="ma5" class="corr-indicator" checked> 5æ—¥å‡ä»·
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" value="volume" class="corr-indicator"> æˆäº¤é‡
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" value="change_percent" class="corr-indicator"> æ¶¨è·Œå¹…
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" value="volatility" class="corr-indicator"> æ³¢åŠ¨ç‡
                        </label>
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        æ³¨: è‹¥åŒ…å«å®è§‚æ•°æ®(MACRO_*)ï¼Œå°†è‡ªåŠ¨ä½¿ç”¨æœˆåº¦å‡å€¼è¿›è¡Œåˆ†æï¼Œå¿½ç•¥ä¸Šè¿°æŒ‡æ ‡é€‰æ‹©ã€‚
                    </p>
                </div>

                <button class="btn btn-primary" onclick="analyzeCorrelation()">
                    ğŸ“ˆ å¼€å§‹åˆ†æ
                </button>
            </div>

            <div id="correlationResults" style="display: none;">
                <!-- ç›¸å…³æ€§çŸ©é˜µ -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">ç›¸å…³æ€§ç³»æ•°</h3>
                    </div>
                    <div class="correlation-matrix" id="correlationMatrix"></div>
                </div>

                <!-- æ—¶é—´åºåˆ—å›¾è¡¨ -->
                <div id="corrChartsContainer">
                    <!-- Standard Charts -->
                    <div class="grid grid-2 mb-3" id="standardCharts">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">æ¢æ‰‹ç‡å¯¹æ¯”</h3>
                            </div>
                            <div id="turnoverChart" class="chart-container"></div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">æŒ¯å¹…å¯¹æ¯”</h3>
                            </div>
                            <div id="amplitudeChart" class="chart-container"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">è¶‹åŠ¿å¯¹æ¯”</h3>
                        </div>
                        <div id="ma5Chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Tab -->
        <div id="alerts" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">æé†’è®°å½•</h3>
                    <div class="flex gap-1">
                        <button class="btn btn-sm btn-secondary" onclick="checkAlerts()">æ£€æŸ¥æé†’</button>
                        <button class="btn btn-sm btn-danger" onclick="clearAlerts()">æ¸…é™¤å…¨éƒ¨</button>
                    </div>
                </div>
                <div id="alertsList">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ””</div>
                        <p>æš‚æ— æé†’è®°å½•</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sentiment Tab - èˆ†æƒ…æŒ‡æ•° -->
        <div id="sentiment" class="tab-content">
            <!-- å¸‚åœºèˆ†æƒ…æŒ‡æ•° -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“¢ å¸‚åœºèˆ†æƒ…æŒ‡æ•°</h3>
                    <div class="flex gap-1">
                        <select class="input" id="sentimentCategory" style="width: auto; min-width: 120px;">
                            <option value="all">å…¨éƒ¨æ–°é—»</option>
                            <option value="stock">è‚¡ç¥¨æ–°é—»</option>
                            <option value="market">å¤§ç›˜åˆ†æ</option>
                            <option value="finance">è´¢ç»æ–°é—»</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadMarketSentiment()">åˆ·æ–°åˆ†æ</button>
                    </div>
                </div>
                <div id="marketSentimentContent">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“Š</div>
                        <p>ç‚¹å‡»"åˆ·æ–°åˆ†æ"è·å–å¸‚åœºèˆ†æƒ…æŒ‡æ•°</p>
                    </div>
                </div>
            </div>

            <!-- ä¸ªè‚¡èˆ†æƒ…å¯¹æ¯” -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“Š ä¸ªè‚¡èˆ†æƒ…å¯¹æ¯”</h3>
                </div>
                <div class="form-group mb-2">
                    <div class="input-group">
                        <input type="text" class="input" id="sentimentCompareInput"
                               placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œç”¨é€—å·åˆ†éš”ï¼ˆå¦‚ï¼š000001,600000,00700ï¼‰">
                        <button class="btn btn-primary" onclick="compareSentiment()">å¯¹æ¯”åˆ†æ</button>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <button class="btn btn-sm btn-secondary" onclick="fillSentimentFromWatchlist()">ä»å…³æ³¨åˆ—è¡¨é€‰æ‹©</button>
                    </div>
                </div>
                <div id="sentimentCompareContent">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“ˆ</div>
                        <p>è¾“å…¥å¤šåªè‚¡ç¥¨ä»£ç è¿›è¡Œèˆ†æƒ…å¯¹æ¯”</p>
                    </div>
                </div>
            </div>

            <!-- ä¸ªè‚¡èˆ†æƒ…è¯¦æƒ… -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ” ä¸ªè‚¡èˆ†æƒ…è¯¦æƒ…</h3>
                </div>
                <div class="form-group mb-2">
                    <div class="input-group">
                        <input type="text" class="input" id="stockSentimentInput" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ï¼š000001ï¼‰">
                        <button class="btn btn-primary" onclick="loadStockSentiment()">åˆ†æèˆ†æƒ…</button>
                    </div>
                </div>
                <div id="stockSentimentContent">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ”</div>
                        <p>è¾“å…¥è‚¡ç¥¨ä»£ç æŸ¥çœ‹è¯¦ç»†èˆ†æƒ…åˆ†æ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Technical Tab - æŠ€æœ¯æŒ‡æ ‡ -->
        <div id="technical" class="tab-content">
            <!-- è‚¡ç¥¨é€‰æ‹© -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“‰ æŠ€æœ¯æŒ‡æ ‡åˆ†æ</h3>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <input type="text" class="input" id="technicalStockInput" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ï¼š000001ï¼‰">
                        <select class="input" id="technicalDays" style="width: auto; min-width: 120px;">
                            <option value="60">60å¤©</option>
                            <option value="120" selected>120å¤©</option>
                            <option value="250">250å¤©</option>
                            <option value="500">500å¤©</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadTechnicalAnalysis()">åˆ†æ</button>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <button class="btn btn-sm btn-secondary" onclick="fillTechnicalFromWatchlist()">ä»å…³æ³¨åˆ—è¡¨é€‰æ‹©</button>
                    </div>
                </div>
            </div>

            <!-- æŠ€æœ¯ä¿¡å·æ‘˜è¦ -->
            <div id="technicalSignals" class="card mb-3" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">ğŸ¯ æŠ€æœ¯ä¿¡å·æ‘˜è¦</h3>
                    <div class="overall-signal" id="overallSignal">--</div>
                </div>
                <div id="signalsList"></div>
            </div>

            <!-- æŠ€æœ¯æŒ‡æ ‡æ•°å€¼ -->
            <div id="technicalValues" class="card mb-3" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“Š æŒ‡æ ‡æ•°å€¼</h3>
                </div>
                <div class="grid grid-4" id="indicatorValues"></div>
            </div>

            <!-- Kçº¿å›¾å’ŒæŠ€æœ¯æŒ‡æ ‡å›¾è¡¨ -->
            <div id="technicalCharts" style="display: none;">
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“ˆ Kçº¿èµ°åŠ¿ä¸å‡çº¿</h3>
                    </div>
                    <div id="klineChart" class="chart-container" style="height: 400px;"></div>
                </div>

                <div class="grid grid-2 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">MACD</h3>
                        </div>
                        <div id="macdChart" class="chart-container" style="height: 250px;"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">KDJ</h3>
                        </div>
                        <div id="kdjChart" class="chart-container" style="height: 250px;"></div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">RSI</h3>
                        </div>
                        <div id="rsiChart" class="chart-container" style="height: 250px;"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">å¸ƒæ—å¸¦ (BOLL)</h3>
                        </div>
                        <div id="bollChart" class="chart-container" style="height: 250px;"></div>
                    </div>
                </div>
            </div>

            <!-- åˆå§‹çŠ¶æ€ -->
            <div id="technicalEmpty" class="card">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“‰</div>
                    <p>è¾“å…¥è‚¡ç¥¨ä»£ç æŸ¥çœ‹æŠ€æœ¯æŒ‡æ ‡åˆ†æ</p>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem;">
                        æ”¯æŒ MACDã€KDJã€RSIã€å¸ƒæ—å¸¦ã€å‡çº¿ç³»ç»Ÿåˆ†æ
                    </p>
                </div>
            </div>
        </div>

        <!-- Sectors Tab - æ¿å—åˆ†æ -->
        <div id="sectors" class="tab-content">
            <!-- æ¿å—æ¦‚è§ˆ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ­ æ¿å—æ¦‚è§ˆ</h3>
                    <button class="btn btn-primary" onclick="loadSectorOverview()">åˆ·æ–°æ•°æ®</button>
                </div>
                <div id="sectorOverview">
                    <div class="empty-state" style="padding: 1rem;">
                        <p>ç‚¹å‡»"åˆ·æ–°æ•°æ®"åŠ è½½æ¿å—æ¦‚è§ˆ</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-2 mb-3">
                <!-- è¡Œä¸šæ¿å—æ¶¨è·Œæ¦œ -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“ˆ è¡Œä¸šæ¿å—æ¶¨å¹…æ¦œ</h3>
                        <select class="input" id="industrySort" style="width: auto; min-width: 100px;" onchange="loadIndustrySectors()">
                            <option value="up">æ¶¨å¹…æ¦œ</option>
                            <option value="down">è·Œå¹…æ¦œ</option>
                        </select>
                    </div>
                    <div id="industrySectorList" class="sector-list">
                        <div class="empty-state" style="padding: 1rem;"><p>åŠ è½½ä¸­...</p></div>
                    </div>
                </div>

                <!-- æ¦‚å¿µæ¿å—æ¶¨è·Œæ¦œ -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ’¡ æ¦‚å¿µæ¿å—æ¶¨å¹…æ¦œ</h3>
                        <select class="input" id="conceptSort" style="width: auto; min-width: 100px;" onchange="loadConceptSectors()">
                            <option value="up">æ¶¨å¹…æ¦œ</option>
                            <option value="down">è·Œå¹…æ¦œ</option>
                        </select>
                    </div>
                    <div id="conceptSectorList" class="sector-list">
                        <div class="empty-state" style="padding: 1rem;"><p>åŠ è½½ä¸­...</p></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-2">
                <!-- èµ„é‡‘æµå…¥æ¦œ -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ’° èµ„é‡‘æµå…¥æ¦œ</h3>
                        <select class="input" id="flowType" style="width: auto; min-width: 100px;" onchange="loadSectorFlow()">
                            <option value="industry">è¡Œä¸šæ¿å—</option>
                            <option value="concept">æ¦‚å¿µæ¿å—</option>
                        </select>
                    </div>
                    <div id="sectorFlowInList" class="sector-list">
                        <div class="empty-state" style="padding: 1rem;"><p>åŠ è½½ä¸­...</p></div>
                    </div>
                </div>

                <!-- èµ„é‡‘æµå‡ºæ¦œ -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ’¸ èµ„é‡‘æµå‡ºæ¦œ</h3>
                    </div>
                    <div id="sectorFlowOutList" class="sector-list">
                        <div class="empty-state" style="padding: 1rem;"><p>åŠ è½½ä¸­...</p></div>
                    </div>
                </div>
            </div>

            <!-- æ¿å—æˆåˆ†è‚¡è¯¦æƒ… -->
            <div class="card mt-3" id="sectorDetailCard" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title" id="sectorDetailTitle">æ¿å—æˆåˆ†è‚¡</h3>
                    <button class="btn btn-sm btn-secondary" onclick="closeSectorDetail()">å…³é—­</button>
                </div>
                <div id="sectorDetailContent"></div>
            </div>
        </div>

        <!-- Finance Tab - è´¢æŠ¥åˆ†æ -->
        <div id="finance" class="tab-content">
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“‘ è´¢æŠ¥åˆ†æ</h3>
                </div>
                <div class="search-box">
                    <input type="text" id="financeCodeInput" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œå¦‚ï¼š600036"
                           style="padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); width: 200px;">
                    <button class="btn btn-primary" onclick="loadFinanceAnalysis()">åˆ†æè´¢æŠ¥</button>
                    <button class="btn btn-secondary" onclick="fillFinanceFromWatchlist()">ä»å…³æ³¨åˆ—è¡¨é€‰æ‹©</button>
                </div>
                <!-- å…³æ³¨åˆ—è¡¨å¿«é€Ÿé€‰æ‹© -->
                <div id="financeWatchlistSelector" style="display: none; margin-top: 1rem;">
                    <div class="card-title" style="font-size: 0.9rem; margin-bottom: 0.5rem;">é€‰æ‹©è‚¡ç¥¨ï¼š</div>
                    <div id="financeWatchlistItems" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                </div>
            </div>

            <!-- è´¢åŠ¡åˆ†æç»“æœåŒºåŸŸ -->
            <div id="financeResult" style="display: none;">
                <!-- è‚¡ç¥¨ä¿¡æ¯ -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <span id="financeStockName">--</span>
                            <span id="financeStockCode" style="color: var(--text-secondary); font-size: 0.9rem; margin-left: 0.5rem;"></span>
                        </h3>
                        <div class="flex gap-1" style="align-items: center;">
                            <span id="financeStockPrice" style="font-size: 1.2rem; font-weight: 600;">--</span>
                            <span id="financeStockChange" style="margin-left: 0.5rem;">--</span>
                            <button class="btn btn-sm btn-secondary" onclick="exportFinanceData()" style="margin-left: 1rem;">ğŸ“¥ å¯¼å‡ºè´¢åŠ¡æ•°æ®</button>
                        </div>
                    </div>
                </div>

                <!-- è´¢åŠ¡å¥åº·åº¦è¯„åˆ† -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ¥ è´¢åŠ¡å¥åº·åº¦è¯„åˆ†</h3>
                    </div>
                    <div id="financeHealthScore">
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 1rem;">
                            <div style="text-align: center;">
                                <div id="healthTotalScore" style="font-size: 3rem; font-weight: 700;">--</div>
                                <div id="healthTotalLevel" style="font-size: 1rem;">--</div>
                            </div>
                            <div id="healthInterpretation" style="flex: 1; color: var(--text-secondary); font-size: 0.9rem;"></div>
                        </div>
                        <div class="grid grid-4" id="healthDetailScores">
                            <!-- å››ä¸ªç»´åº¦è¯„åˆ† -->
                        </div>
                    </div>
                </div>

                <!-- ä¸»è¦è´¢åŠ¡æŒ‡æ ‡ -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ“Š ä¸»è¦è´¢åŠ¡æŒ‡æ ‡</h3>
                    </div>
                    <div id="financeIndicators" style="overflow-x: auto;">
                        <table class="data-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>æŠ¥å‘ŠæœŸ</th>
                                    <th>æ¯è‚¡æ”¶ç›Š(EPS)</th>
                                    <th>å‡€èµ„äº§æ”¶ç›Šç‡(ROE)</th>
                                    <th>æ¯›åˆ©ç‡</th>
                                    <th>å‡€åˆ©ç‡</th>
                                    <th>èµ„äº§è´Ÿå€ºç‡</th>
                                </tr>
                            </thead>
                            <tbody id="financeIndicatorsBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- è´¢åŠ¡æ¯”ç‡åˆ†æ -->
                <div class="grid grid-2 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ’° ç›ˆåˆ©èƒ½åŠ›</h3>
                        </div>
                        <div id="profitabilityRatios"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ¦ å¿å€ºèƒ½åŠ›</h3>
                        </div>
                        <div id="solvencyRatios"></div>
                    </div>
                </div>

                <div class="grid grid-2 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">âš™ï¸ è¿è¥èƒ½åŠ›</h3>
                        </div>
                        <div id="operationRatios"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ“ˆ æˆé•¿èƒ½åŠ›</h3>
                        </div>
                        <div id="growthRatios"></div>
                    </div>
                </div>

                <!-- è¡Œä¸šå¯¹æ¯” -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">ğŸ­ åŒè¡Œä¸šå¯¹æ¯”</h3>
                        <span id="financeIndustryName" style="color: var(--text-secondary);"></span>
                    </div>
                    <div id="industryComparison">
                        <div style="margin-bottom: 1rem;">
                            <span style="font-size: 0.9rem; color: var(--text-secondary);">è¡Œä¸šæ’åï¼š</span>
                            <span id="industryRank" style="font-weight: 600;">--</span>
                        </div>
                        <div class="grid grid-5" id="industryAvgMetrics">
                            <!-- è¡Œä¸šå¹³å‡æŒ‡æ ‡ -->
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">åŒè¡Œä¸šå…¬å¸ï¼š</div>
                            <div id="industryPeers" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>

                <!-- è´¢åŠ¡è¶‹åŠ¿å›¾è¡¨ -->
                <div class="grid grid-2 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ“‰ ROEè¶‹åŠ¿</h3>
                        </div>
                        <div id="roeTrendChart" style="height: 250px;"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ“‰ åˆ©æ¶¦ç‡è¶‹åŠ¿</h3>
                        </div>
                        <div id="marginTrendChart" style="height: 250px;"></div>
                    </div>
                </div>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="financeLoading" style="display: none; text-align: center; padding: 3rem;">
                <div class="loading">åŠ è½½è´¢åŠ¡æ•°æ®ä¸­...</div>
            </div>
        </div>

        <!-- Screener Tab - é€‰è‚¡å™¨ -->
        <div id="screener" class="tab-content">
            <!-- å¿«é€Ÿç­›é€‰ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">âš¡ å¿«é€Ÿç­›é€‰</h3>
                </div>
                <div id="quickScreenButtons" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    <button class="btn btn-sm" style="background: var(--bg-secondary);" onclick="quickScreen('low_pe')">ğŸ’ ä½ä¼°å€¼è‚¡ç¥¨</button>
                    <button class="btn btn-sm" style="background: var(--bg-secondary);" onclick="quickScreen('big_cap')">ğŸ›ï¸ å¤§ç›˜è“ç­¹</button>
                    <button class="btn btn-sm" style="background: var(--bg-secondary);" onclick="quickScreen('small_cap_growth')">ğŸŒ± å°ç›˜æˆé•¿</button>
                    <button class="btn btn-sm" style="background: var(--bg-secondary);" onclick="quickScreen('high_turnover')">ğŸ”¥ æ´»è·ƒè‚¡ç¥¨</button>
                    <button class="btn btn-sm" style="background: var(--bg-secondary);" onclick="quickScreen('high_volume')">ğŸ“ˆ æ”¾é‡ä¸Šæ¶¨</button>
                    <button class="btn btn-sm" style="background: var(--accent-green);" onclick="quickScreen('limit_up')">ğŸš€ æ¶¨åœæ¿</button>
                    <button class="btn btn-sm" style="background: var(--accent-red);" onclick="quickScreen('limit_down')">ğŸ’¥ è·Œåœæ¿</button>
                </div>
            </div>

            <!-- è‡ªå®šä¹‰ç­›é€‰ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ”§ è‡ªå®šä¹‰ç­›é€‰</h3>
                    <button class="btn btn-primary" onclick="customScreen()">å¼€å§‹ç­›é€‰</button>
                </div>
                <div class="grid grid-4" style="gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">å¸‚å€¼èŒƒå›´(äº¿)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="number" id="screenMarketCapMin" class="input" placeholder="æœ€å°" style="width: 80px;">
                            <span style="color: var(--text-secondary);">-</span>
                            <input type="number" id="screenMarketCapMax" class="input" placeholder="æœ€å¤§" style="width: 80px;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">å¸‚ç›ˆç‡(PE)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="number" id="screenPeMin" class="input" placeholder="æœ€å°" style="width: 80px;">
                            <span style="color: var(--text-secondary);">-</span>
                            <input type="number" id="screenPeMax" class="input" placeholder="æœ€å¤§" style="width: 80px;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">æ¶¨è·Œå¹…(%)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="number" id="screenChangeMin" class="input" placeholder="æœ€å°" style="width: 80px;">
                            <span style="color: var(--text-secondary);">-</span>
                            <input type="number" id="screenChangeMax" class="input" placeholder="æœ€å¤§" style="width: 80px;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">æ¢æ‰‹ç‡(%)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="number" id="screenTurnoverMin" class="input" placeholder="æœ€å°" style="width: 80px;">
                            <span style="color: var(--text-secondary);">-</span>
                            <input type="number" id="screenTurnoverMax" class="input" placeholder="æœ€å¤§" style="width: 80px;">
                        </div>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 1rem; align-items: center;">
                    <div>
                        <label style="color: var(--text-secondary); font-size: 0.9rem; margin-right: 0.5rem;">æ’åºï¼š</label>
                        <select id="screenSortBy" class="input" style="width: 120px;">
                            <option value="market_cap">å¸‚å€¼</option>
                            <option value="change">æ¶¨è·Œå¹…</option>
                            <option value="turnover">æ¢æ‰‹ç‡</option>
                            <option value="pe">å¸‚ç›ˆç‡</option>
                            <option value="amount">æˆäº¤é¢</option>
                        </select>
                        <select id="screenSortOrder" class="input" style="width: 80px;">
                            <option value="desc">é™åº</option>
                            <option value="asc">å‡åº</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="clearScreenFilter()">æ¸…ç©ºæ¡ä»¶</button>
                </div>
            </div>

            <!-- ç­›é€‰ç»“æœ -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“‹ ç­›é€‰ç»“æœ <span id="screenResultCount" style="color: var(--text-secondary); font-size: 0.9rem;"></span></h3>
                    <span id="screenPresetName" style="color: var(--accent-blue);"></span>
                </div>
                <div id="screenResultLoading" style="display: none; text-align: center; padding: 2rem;">
                    <div class="loading">ç­›é€‰ä¸­...</div>
                </div>
                <div id="screenResultTable" style="overflow-x: auto;">
                    <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        è¯·é€‰æ‹©ç­›é€‰æ¡ä»¶æˆ–ç‚¹å‡»å¿«é€Ÿç­›é€‰æŒ‰é’®
                    </div>
                </div>
                <!-- åˆ†é¡µ -->
                <div id="screenPagination" style="display: none; margin-top: 1rem; display: flex; justify-content: center; gap: 0.5rem;">
                </div>
            </div>
        </div>

        <!-- US Stock Tab - ç¾è‚¡ -->
        <div id="us_stock" class="tab-content">
            <!-- ç¾è‚¡æŒ‡æ•° -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“Š ç¾è‚¡æŒ‡æ•°</h3>
                    <button class="btn btn-sm btn-secondary" onclick="loadUSMarket()">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div class="grid grid-4" id="usIndicesGrid">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- ç¾è‚¡æœç´¢ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ” ç¾è‚¡æœç´¢</h3>
                </div>
                <div class="input-group" style="position: relative;">
                    <input type="text" class="input" id="usSearchInput" placeholder="è¾“å…¥ç¾è‚¡ä»£ç æˆ–åç§°ï¼Œå¦‚ AAPL, Apple..." autocomplete="off">
                    <button class="btn btn-primary" onclick="searchUSStock()">æœç´¢</button>
                </div>
                <div id="usSearchResults" style="margin-top: 1rem;"></div>
            </div>

            <!-- ä¸­æ¦‚è‚¡ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ‡¨ğŸ‡³ ä¸­æ¦‚è‚¡</h3>
                </div>
                <div id="chinaAdrList">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- çƒ­é—¨ç¾è‚¡ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ”¥ çƒ­é—¨ç¾è‚¡</h3>
                </div>
                <div id="popularUSList">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- ç¾è‚¡è¯¦æƒ… -->
            <div id="usStockDetail" class="card" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">
                        <span id="usDetailName">--</span>
                        <span id="usDetailSymbol" style="color: var(--text-secondary); font-size: 0.9rem; margin-left: 0.5rem;"></span>
                    </h3>
                    <button class="btn btn-sm btn-secondary" onclick="closeUSDetail()">å…³é—­</button>
                </div>
                <div class="grid grid-4" style="margin-bottom: 1rem;">
                    <div class="stat-card">
                        <div class="stat-label">ç°ä»·</div>
                        <div class="stat-value" id="usDetailPrice">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æ¶¨è·Œå¹…</div>
                        <div class="stat-value" id="usDetailChange">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¸‚å€¼</div>
                        <div class="stat-value" id="usDetailMarketCap">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¸‚ç›ˆç‡(PE)</div>
                        <div class="stat-value" id="usDetailPE">--</div>
                    </div>
                </div>
                <div id="usKlineChart" style="height: 300px;"></div>
            </div>
        </div>

        <!-- Portfolio Tab - æˆ‘çš„æŒä»“ -->
        <div id="portfolio" class="tab-content">
            <!-- æŒä»“æ±‡æ€» -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ’¼ æŒä»“æ±‡æ€»</h3>
                    <div class="flex gap-1">
                        <button class="btn btn-primary" onclick="loadPortfolio()">åˆ·æ–°</button>
                        <button class="btn btn-sm btn-secondary" onclick="exportPortfolio()">ğŸ“¥ å¯¼å‡ºæŒä»“</button>
                    </div>
                </div>
                <div id="portfolioSummary">
                    <div class="grid grid-4" style="padding: 0.5rem 0;">
                        <div class="stat-card blue">
                            <div class="stat-label">æŒä»“å¸‚å€¼</div>
                            <div class="stat-value" id="pfTotalCurrent">--</div>
                        </div>
                        <div class="stat-card purple">
                            <div class="stat-label">æŒä»“æˆæœ¬</div>
                            <div class="stat-value" id="pfTotalCost">--</div>
                        </div>
                        <div class="stat-card" id="pfProfitCard">
                            <div class="stat-label">æ€»ç›ˆäº</div>
                            <div class="stat-value" id="pfTotalProfit">--</div>
                            <div class="stat-change" id="pfProfitPercent">--</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æŒä»“/ç›ˆåˆ©/äºæŸ</div>
                            <div class="stat-value" id="pfCounts">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¹°å…¥/å–å‡ºæ“ä½œ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“ äº¤æ˜“æ“ä½œ</h3>
                </div>
                <div class="grid grid-2" style="gap: 1rem;">
                    <div class="trade-form">
                        <h4 style="color: var(--accent-green); margin-bottom: 0.75rem;">ä¹°å…¥</h4>
                        <div class="form-group mb-1">
                            <input type="text" class="input" id="buyCode" placeholder="è‚¡ç¥¨ä»£ç ">
                        </div>
                        <div class="form-group mb-1">
                            <input type="number" class="input" id="buyPrice" placeholder="ä¹°å…¥ä»·æ ¼" step="0.01">
                        </div>
                        <div class="form-group mb-1">
                            <input type="number" class="input" id="buyQuantity" placeholder="ä¹°å…¥æ•°é‡ï¼ˆè‚¡ï¼‰" step="100">
                        </div>
                        <div class="form-group mb-1">
                            <input type="text" class="input" id="buyNote" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰">
                        </div>
                        <div id="buyFeePreview" style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;"></div>
                        <button class="btn btn-primary" onclick="executeBuy()" style="width: 100%;">ç¡®è®¤ä¹°å…¥</button>
                    </div>
                    <div class="trade-form">
                        <h4 style="color: var(--accent-red); margin-bottom: 0.75rem;">å–å‡º</h4>
                        <div class="form-group mb-1">
                            <select class="input" id="sellCode" onchange="updateSellInfo()">
                                <option value="">é€‰æ‹©æŒä»“è‚¡ç¥¨</option>
                            </select>
                        </div>
                        <div class="form-group mb-1">
                            <input type="number" class="input" id="sellPrice" placeholder="å–å‡ºä»·æ ¼" step="0.01">
                        </div>
                        <div class="form-group mb-1">
                            <input type="number" class="input" id="sellQuantity" placeholder="å–å‡ºæ•°é‡ï¼ˆè‚¡ï¼‰" step="100">
                        </div>
                        <div id="sellInfo" style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;"></div>
                        <button class="btn btn-danger" onclick="executeSell()" style="width: 100%;">ç¡®è®¤å–å‡º</button>
                    </div>
                </div>
            </div>

            <!-- æŒä»“åˆ—è¡¨ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“Š æŒä»“æ˜ç»†</h3>
                </div>
                <div id="positionsList">
                    <div class="empty-state" style="padding: 1rem;">
                        <div class="empty-icon">ğŸ’¼</div>
                        <p>æš‚æ— æŒä»“ï¼Œè¯·å…ˆä¹°å…¥è‚¡ç¥¨</p>
                    </div>
                </div>
            </div>

            <!-- äº¤æ˜“è®°å½• -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“œ äº¤æ˜“è®°å½•</h3>
                    <button class="btn btn-sm btn-secondary" onclick="loadTransactions()">åˆ·æ–°</button>
                </div>
                <div id="transactionsList">
                    <div class="empty-state" style="padding: 1rem;">
                        <p>æš‚æ— äº¤æ˜“è®°å½•</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div class="modal-overlay" id="addStockModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">æ·»åŠ è‚¡ç¥¨åˆ°å…³æ³¨åˆ—è¡¨</h3>
                <button class="modal-close" onclick="closeModal('addStockModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">è‚¡ç¥¨</label>
                    <input type="text" class="input" id="modalStockName" readonly>
                    <input type="hidden" id="modalStockCode">
                </div>
                <div class="form-group">
                    <label class="form-label">æ¶¨å¹…æé†’é˜ˆå€¼ (%)</label>
                    <input type="number" class="input" id="modalAlertUp" placeholder="å¦‚ï¼š5 è¡¨ç¤ºæ¶¨å¹…è¶…è¿‡5%æ—¶æé†’">
                </div>
                <div class="form-group">
                    <label class="form-label">è·Œå¹…æé†’é˜ˆå€¼ (%)</label>
                    <input type="number" class="input" id="modalAlertDown" placeholder="å¦‚ï¼š-5 è¡¨ç¤ºè·Œå¹…è¶…è¿‡5%æ—¶æé†’">
                </div>
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <input type="text" class="input" id="modalNote" placeholder="å¯é€‰å¤‡æ³¨">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addStockModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmAddStock()">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- Stock Detail Modal -->
    <div class="modal-overlay" id="stockDetailModal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="detailModalTitle">è‚¡ç¥¨è¯¦æƒ…</h3>
                <button class="modal-close" onclick="closeModal('stockDetailModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="stockDetailContent">
                    <div class="ai-loading">
                        <div class="spinner"></div>
                        <span>åŠ è½½ä¸­...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';

        // Tab switching
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                switchTab(tabId);
            });
        });

        function switchTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // API calls
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, message: error.message };
            }
        }

        // Load market sentiment
        async function loadMarketSentiment() {
            const result = await apiCall('/api/stocks/market/sentiment');
            if (result.success && result.data) {
                const data = result.data;
                document.getElementById('upCount').textContent = data.up_count || 0;
                document.getElementById('downCount').textContent = data.down_count || 0;
                document.getElementById('limitCount').textContent = `${data.limit_up_count || 0} / ${data.limit_down_count || 0}`;

                const northFlow = data.north_net_inflow || 0;
                document.getElementById('northFlow').textContent = northFlow.toFixed(2);
                document.getElementById('northFlow').className = 'stat-value ' + (northFlow >= 0 ? 'green' : 'red');

                // Update sentiment chart
                updateSentimentChart(data);
            }
            document.getElementById('connectionStatus').textContent = 'å·²è¿æ¥';
        }

        // Sentiment chart
        let sentimentChart = null;
        function updateSentimentChart(data) {
            if (!sentimentChart) {
                sentimentChart = echarts.init(document.getElementById('sentimentChart'));
            }

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    right: 10,
                    top: 'center',
                    textStyle: { color: '#a0a0a0' }
                },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['40%', '50%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#16213e',
                        borderWidth: 2
                    },
                    label: { show: false },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 16,
                            fontWeight: 'bold',
                            color: '#fff'
                        }
                    },
                    data: [
                        { value: data.up_count || 0, name: 'ä¸Šæ¶¨', itemStyle: { color: '#ef4444' } },
                        { value: data.down_count || 0, name: 'ä¸‹è·Œ', itemStyle: { color: '#10b981' } },
                        { value: data.flat_count || 0, name: 'å¹³ç›˜', itemStyle: { color: '#6b7280' } }
                    ]
                }]
            };

            sentimentChart.setOption(option);
        }

        // North Flow Chart
        let northFlowChart = null;
        async function loadNorthFlowChart() {
            try {
                const result = await apiCall('/api/market/north-flow/minute');
                if (result.success && result.data) {
                    updateNorthFlowChart(result.data);
                }
            } catch (error) {
                console.error('åŠ è½½åŒ—å‘èµ„é‡‘æ•°æ®å¤±è´¥:', error);
            }
        }

        function updateNorthFlowChart(data) {
            if (!northFlowChart) {
                northFlowChart = echarts.init(document.getElementById('northFlowChart'));
            }
            northFlowChart.clear();

            const minuteData = data.minute_data || [];
            const times = minuteData.map(d => d.time);
            const totalData = minuteData.map(d => (d.net_inflow / 100000000).toFixed(2));
            const shData = minuteData.map(d => (d.sh_inflow / 100000000).toFixed(2));
            const szData = minuteData.map(d => (d.sz_inflow / 100000000).toFixed(2));

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(p => {
                            result += `${p.marker} ${p.seriesName}: ${p.value}äº¿<br/>`;
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['åŒ—å‘æ€»è®¡', 'æ²ªè‚¡é€š', 'æ·±è‚¡é€š'],
                    textStyle: { color: '#a0a0a0', fontSize: 10 },
                    top: 0
                },
                grid: {
                    left: '12%',
                    right: '5%',
                    bottom: '12%',
                    top: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLine: { lineStyle: { color: '#2d2d5a' } },
                    axisLabel: { color: '#a0a0a0', fontSize: 9 }
                },
                yAxis: {
                    type: 'value',
                    name: 'äº¿å…ƒ',
                    nameTextStyle: { color: '#a0a0a0', fontSize: 10 },
                    axisLine: { lineStyle: { color: '#2d2d5a' } },
                    axisLabel: { color: '#a0a0a0', fontSize: 10 },
                    splitLine: { lineStyle: { color: '#2d2d5a', type: 'dashed' } }
                },
                series: [
                    {
                        name: 'åŒ—å‘æ€»è®¡',
                        type: 'line',
                        data: totalData,
                        smooth: true,
                        lineStyle: { width: 2, color: '#f59e0b' },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: 'rgba(245, 158, 11, 0.3)' },
                                    { offset: 1, color: 'rgba(245, 158, 11, 0.05)' }
                                ]
                            }
                        },
                        symbol: 'none'
                    },
                    {
                        name: 'æ²ªè‚¡é€š',
                        type: 'line',
                        data: shData,
                        smooth: true,
                        lineStyle: { width: 1, color: '#ef4444' },
                        symbol: 'none'
                    },
                    {
                        name: 'æ·±è‚¡é€š',
                        type: 'line',
                        data: szData,
                        smooth: true,
                        lineStyle: { width: 1, color: '#10b981' },
                        symbol: 'none'
                    }
                ]
            };

            northFlowChart.setOption(option);

            // æ›´æ–°ä¿¡æ¯
            const total = (data.total_net / 100000000).toFixed(2);
            const sh = (data.sh_net / 100000000).toFixed(2);
            const sz = (data.sz_net / 100000000).toFixed(2);
            const infoEl = document.getElementById('northFlowInfo');
            const color = data.total_net >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            infoEl.innerHTML = `
                <span style="color: ${color}; font-weight: bold;">ä»Šæ—¥: ${total}äº¿</span>
                <span style="margin-left: 1rem;">æ²ªè‚¡é€š: ${sh}äº¿</span>
                <span style="margin-left: 1rem;">æ·±è‚¡é€š: ${sz}äº¿</span>
            `;
        }

        // North Holdings
        async function loadNorthHoldings() {
            const container = document.getElementById('northHoldingsList');
            container.innerHTML = '<div class="ai-loading"><div class="spinner"></div><span>åŠ è½½ä¸­...</span></div>';

            try {
                const result = await apiCall('/api/market/north-flow/holdings?count=10');
                if (result.success && result.data && result.data.holdings) {
                    const holdings = result.data.holdings;
                    let html = '<div class="holdings-list">';
                    holdings.forEach((stock, index) => {
                        const changeColor = stock.change_percent >= 0 ? 'price-up' : 'price-down';
                        const holdRatio = (stock.hold_ratio * 100).toFixed(2);
                        const holdCap = (stock.hold_market_cap / 100000000).toFixed(2);
                        html += `
                            <div class="holding-item" onclick="showStockDetail('${stock.code}')">
                                <div class="holding-rank">${index + 1}</div>
                                <div class="holding-info">
                                    <div class="holding-name">${stock.name}</div>
                                    <div class="holding-code">${stock.code}</div>
                                </div>
                                <div class="holding-stats">
                                    <div class="holding-ratio">æŒè‚¡${holdRatio}%</div>
                                    <div class="holding-cap">${holdCap}äº¿</div>
                                </div>
                                <div class="holding-change ${changeColor}">${stock.change_percent >= 0 ? '+' : ''}${stock.change_percent.toFixed(2)}%</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>æš‚æ— æ•°æ®</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>åŠ è½½å¤±è´¥</p></div>';
            }
        }

        // Search stock
        let searchTimeout = null;
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const keyword = this.value.trim();
            if (keyword.length < 1) {
                document.getElementById('searchResults').classList.remove('show');
                return;
            }
            searchTimeout = setTimeout(() => searchStock(), 300);
        });

        async function searchStock() {
            const keyword = document.getElementById('searchInput').value.trim();
            if (!keyword) return;

            const result = await apiCall(`/api/stocks/search?keyword=${encodeURIComponent(keyword)}`);
            const resultsDiv = document.getElementById('searchResults');

            if (result.success && result.data && result.data.length > 0) {
                resultsDiv.innerHTML = result.data.map(stock => `
                    <div class="search-item" onclick="selectStock('${stock.code}', '${stock.name}')">
                        <span>${stock.name}</span>
                        <span class="stock-code">${stock.code}</span>
                    </div>
                `).join('');
                resultsDiv.classList.add('show');
            } else {
                resultsDiv.innerHTML = '<div class="search-item">æœªæ‰¾åˆ°ç›¸å…³è‚¡ç¥¨</div>';
                resultsDiv.classList.add('show');
            }
        }

        function selectStock(code, name) {
            document.getElementById('searchResults').classList.remove('show');
            document.getElementById('searchInput').value = '';
            document.getElementById('modalStockCode').value = code;
            document.getElementById('modalStockName').value = `${name} (${code})`;
            openModal('addStockModal');
        }

        // Add stock to watch list
        async function confirmAddStock() {
            const code = document.getElementById('modalStockCode').value;
            const alertUp = document.getElementById('modalAlertUp').value;
            const alertDown = document.getElementById('modalAlertDown').value;
            const note = document.getElementById('modalNote').value;

            const result = await apiCall('/api/stocks/watch-list', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    code,
                    alert_up: alertUp ? parseFloat(alertUp) : null,
                    alert_down: alertDown ? parseFloat(alertDown) : null,
                    note
                })
            });

            if (result.success) {
                closeModal('addStockModal');
                loadWatchListQuotes();
                alert('æ·»åŠ æˆåŠŸï¼');
            } else {
                alert('æ·»åŠ å¤±è´¥ï¼š' + (result.detail || result.message));
            }
        }

        // ============ åˆ†ç»„ç®¡ç† ============
        let currentGroup = 'all';
        let groupsData = [];

        async function loadGroups() {
            try {
                const result = await apiCall('/api/stocks/groups');
                if (result.success && result.data) {
                    groupsData = result.data;
                    renderGroupTabs();
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†ç»„å¤±è´¥:', error);
            }
        }

        function renderGroupTabs() {
            const container = document.getElementById('groupTabs');
            let html = `
                <button class="group-tab ${currentGroup === 'all' ? 'active' : ''}" data-group="all" onclick="selectGroup('all')">å…¨éƒ¨</button>
            `;

            groupsData.forEach(g => {
                html += `
                    <button class="group-tab ${currentGroup === g.name ? 'active' : ''}" data-group="${g.name}" onclick="selectGroup('${g.name}')">
                        ${g.name === 'default' ? 'é»˜è®¤' : g.name}
                        <span class="count">(${g.count})</span>
                    </button>
                `;
            });

            container.innerHTML = html;
        }

        function selectGroup(group) {
            currentGroup = group;
            document.querySelectorAll('.group-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.group === group);
            });
            document.getElementById('currentGroupLabel').textContent = group === 'all' ? '' : `- ${group === 'default' ? 'é»˜è®¤' : group}`;
            loadWatchListQuotes();
        }

        async function createGroup() {
            const name = document.getElementById('newGroupName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥åˆ†ç»„åç§°');
                return;
            }
            if (name === 'all' || name === 'default') {
                alert('ä¸èƒ½ä½¿ç”¨ä¿ç•™åç§°');
                return;
            }
            // åˆ†ç»„ä¼šåœ¨æ·»åŠ è‚¡ç¥¨æ—¶è‡ªåŠ¨åˆ›å»º
            document.getElementById('newGroupName').value = '';
            alert(`åˆ†ç»„ "${name}" å°†åœ¨æ·»åŠ è‚¡ç¥¨æ—¶è‡ªåŠ¨åˆ›å»º`);
            loadGroups();
        }

        async function moveStockToGroup(code, group) {
            try {
                const result = await apiCall(`/api/stocks/watch-list/${code}/group?group=${encodeURIComponent(group)}`, {
                    method: 'PUT'
                });
                if (result.success) {
                    loadGroups();
                    loadWatchListQuotes();
                } else {
                    alert('ç§»åŠ¨å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('ç§»åŠ¨å¤±è´¥: ' + error.message);
            }
        }

        // Load watch list quotes
        async function loadWatchListQuotes() {
            // å…ˆè·å–å…³æ³¨åˆ—è¡¨ï¼ˆåŒ…å«åˆ†ç»„ä¿¡æ¯ï¼‰
            const watchListResult = await apiCall('/api/stocks/watch-list');
            const watchListMap = {};
            if (watchListResult.success && watchListResult.data) {
                watchListResult.data.forEach(item => {
                    watchListMap[item.code] = item;
                });
            }

            const result = await apiCall('/api/stocks/watch-list/quotes');

            if (result.success && result.data && result.data.length > 0) {
                // åˆå¹¶åˆ†ç»„ä¿¡æ¯å¹¶ç­›é€‰
                let stocks = result.data.map(stock => ({
                    ...stock,
                    group: watchListMap[stock.code]?.group || 'default'
                }));

                // æŒ‰åˆ†ç»„ç­›é€‰
                if (currentGroup !== 'all') {
                    stocks = stocks.filter(s => s.group === currentGroup);
                }

                if (stocks.length === 0) {
                    document.getElementById('watchListTable').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“</div>
                            <p>è¯¥åˆ†ç»„æš‚æ— è‚¡ç¥¨</p>
                        </div>
                    `;
                    return;
                }

                const tableHtml = `
                    <table class="stock-table">
                        <thead>
                            <tr>
                                <th>è‚¡ç¥¨</th>
                                <th>åˆ†ç»„</th>
                                <th>æœ€æ–°ä»·</th>
                                <th>æ¶¨è·Œå¹…</th>
                                <th>æˆäº¤é‡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stocks.map(stock => {
                                const changeClass = stock.change_percent > 0 ? 'up' : (stock.change_percent < 0 ? 'down' : 'flat');
                                const priceClass = stock.change_percent > 0 ? 'price-up' : (stock.change_percent < 0 ? 'price-down' : 'price-flat');
                                const groupOptions = groupsData.map(g =>
                                    `<option value="${g.name}" ${stock.group === g.name ? 'selected' : ''}>${g.name === 'default' ? 'é»˜è®¤' : g.name}</option>`
                                ).join('');
                                return `
                                    <tr>
                                        <td>
                                            <div class="stock-name">${formatStockNameWithExchange(stock.name, stock.code)}</div>
                                            <div class="stock-code">${stock.code}</div>
                                        </td>
                                        <td>
                                            <select class="input" style="width: 80px; padding: 0.25rem;" onchange="moveStockToGroup('${stock.code}', this.value)">
                                                ${groupOptions}
                                            </select>
                                        </td>
                                        <td class="${priceClass}">${stock.price?.toFixed(2) || '--'}</td>
                                        <td>
                                            <span class="change-badge ${changeClass}">
                                                ${stock.change_percent > 0 ? '+' : ''}${stock.change_percent?.toFixed(2) || 0}%
                                            </span>
                                        </td>
                                        <td>${formatVolume(stock.volume)}</td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" onclick="viewStockDetail('${stock.code}')">è¯¦æƒ…</button>
                                            <button class="btn btn-sm btn-danger" onclick="removeStock('${stock.code}')">åˆ é™¤</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('watchListTable').innerHTML = tableHtml;

                // Update quick watch list on dashboard
                const quickHtml = result.data.slice(0, 5).map(stock => {
                    const changeClass = stock.change_percent > 0 ? 'up' : (stock.change_percent < 0 ? 'down' : 'flat');
                    const priceClass = stock.change_percent > 0 ? 'price-up' : (stock.change_percent < 0 ? 'price-down' : 'price-flat');
                    return `
                        <div class="flex justify-between items-center" style="padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);">
                            <div>
                                <div class="stock-name">${formatStockNameWithExchange(stock.name, stock.code)}</div>
                                <div class="stock-code">${stock.code}</div>
                            </div>
                            <div class="text-right">
                                <div class="${priceClass}">${stock.price?.toFixed(2) || '--'}</div>
                                <span class="change-badge ${changeClass}">
                                    ${stock.change_percent > 0 ? '+' : ''}${stock.change_percent?.toFixed(2) || 0}%
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('quickWatchList').innerHTML = quickHtml;
            } else {
                document.getElementById('watchListTable').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">â­</div>
                        <p>æš‚æ— å…³æ³¨è‚¡ç¥¨ï¼Œè¯·æœç´¢å¹¶æ·»åŠ </p>
                    </div>
                `;
                document.getElementById('quickWatchList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“‹</div>
                        <p>æš‚æ— å…³æ³¨è‚¡ç¥¨</p>
                    </div>
                `;
            }
        }

        function formatVolume(volume) {
            if (!volume) return '--';
            if (volume >= 10000) {
                return (volume / 10000).toFixed(2) + 'ä¸‡æ‰‹';
            }
            return volume + 'æ‰‹';
        }

        // Get exchange badge for stock code
        function getExchangeBadge(code) {
            if (!code) return '';
            code = code.trim();

            // æ¸¯è‚¡ï¼š5ä½æ•°å­—
            if (code.length === 5 && /^\d+$/.test(code)) {
                return '<span class="exchange-badge" style="background: #722ed1; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem; margin-left: 4px;">æ¸¯</span>';
            }
            // ä¸Šæµ·å¸‚åœºï¼š6æˆ–9å¼€å¤´çš„6ä½æ•°å­—
            else if (code.length === 6 && (code.startsWith('6') || code.startsWith('9'))) {
                return '<span class="exchange-badge" style="background: #1890ff; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem; margin-left: 4px;">æ²ª</span>';
            }
            // æ·±åœ³å¸‚åœºï¼š0ã€2ã€3å¼€å¤´çš„6ä½æ•°å­—
            else if (code.length === 6 && (code.startsWith('0') || code.startsWith('2') || code.startsWith('3'))) {
                return '<span class="exchange-badge" style="background: #52c41a; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem; margin-left: 4px;">æ·±</span>';
            }
            // åŒ—äº¤æ‰€ï¼š4ã€8å¼€å¤´çš„6ä½æ•°å­—
            else if (code.length === 6 && (code.startsWith('4') || code.startsWith('8'))) {
                return '<span class="exchange-badge" style="background: #fa8c16; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem; margin-left: 4px;">åŒ—</span>';
            }
            return '';
        }

        // Format stock name with exchange badge
        function formatStockNameWithExchange(name, code) {
            const badge = getExchangeBadge(code);
            return `${name}${badge}`;
        }

        // Remove stock
        async function removeStock(code) {
            if (!confirm('ç¡®å®šè¦ç§»é™¤è¯¥è‚¡ç¥¨å—ï¼Ÿ')) return;

            const result = await apiCall(`/api/stocks/watch-list/${code}`, { method: 'DELETE' });
            if (result.success) {
                loadWatchListQuotes();
            } else {
                alert('ç§»é™¤å¤±è´¥');
            }
        }

        // View stock detail
        async function viewStockDetail(code) {
            document.getElementById('detailModalTitle').textContent = 'åŠ è½½ä¸­...';
            document.getElementById('stockDetailContent').innerHTML = `
                <div class="ai-loading">
                    <div class="spinner"></div>
                    <span>åŠ è½½è‚¡ç¥¨è¯¦æƒ…...</span>
                </div>
            `;
            openModal('stockDetailModal');

            const [quoteResult, flowResult] = await Promise.all([
                apiCall(`/api/stocks/quote/${code}`),
                apiCall(`/api/stocks/capital-flow/${code}`)
            ]);

            if (quoteResult.success) {
                const quote = quoteResult.data;
                const flow = flowResult.success ? flowResult.data : null;
                const priceClass = quote.change_percent > 0 ? 'price-up' : (quote.change_percent < 0 ? 'price-down' : 'price-flat');

                document.getElementById('detailModalTitle').textContent = `${quote.name} (${quote.code})`;
                document.getElementById('stockDetailContent').innerHTML = `
                    <div class="grid grid-2 mb-2">
                        <div>
                            <div class="stat-label">æœ€æ–°ä»·</div>
                            <div class="stat-value ${priceClass}" style="font-size: 2.5rem;">${quote.price?.toFixed(2)}</div>
                            <div class="stat-change ${priceClass}">
                                ${quote.change > 0 ? '+' : ''}${quote.change?.toFixed(2)}
                                (${quote.change_percent > 0 ? '+' : ''}${quote.change_percent?.toFixed(2)}%)
                            </div>
                        </div>
                        <div class="chart-container" id="detailChart"></div>
                    </div>
                    <div class="grid grid-4 mb-2">
                        <div><span class="stat-label">å¼€ç›˜ä»·</span><br>${quote.open_price?.toFixed(2)}</div>
                        <div><span class="stat-label">æœ€é«˜ä»·</span><br><span class="price-up">${quote.high_price?.toFixed(2)}</span></div>
                        <div><span class="stat-label">æœ€ä½ä»·</span><br><span class="price-down">${quote.low_price?.toFixed(2)}</span></div>
                        <div><span class="stat-label">æ˜¨æ”¶ä»·</span><br>${quote.pre_close?.toFixed(2)}</div>
                    </div>
                    <div class="grid grid-4 mb-2">
                        <div><span class="stat-label">æˆäº¤é‡</span><br>${formatVolume(quote.volume)}</div>
                        <div><span class="stat-label">æˆäº¤é¢</span><br>${formatAmount(quote.amount)}</div>
                        <div><span class="stat-label">æ¢æ‰‹ç‡</span><br>${quote.turnover_rate?.toFixed(2)}%</div>
                        <div><span class="stat-label">å¸‚ç›ˆç‡</span><br>${quote.pe_ratio?.toFixed(2) || '--'}</div>
                    </div>
                    ${flow ? `
                        <div class="card-title mb-1">èµ„é‡‘æµå‘</div>
                        <div class="grid grid-4">
                            <div><span class="stat-label">ä¸»åŠ›å‡€æµå…¥</span><br><span class="${flow.main_net_inflow >= 0 ? 'price-up' : 'price-down'}">${formatFlow(flow.main_net_inflow)}</span></div>
                            <div><span class="stat-label">è¶…å¤§å•</span><br><span class="${flow.super_large_net >= 0 ? 'price-up' : 'price-down'}">${formatFlow(flow.super_large_net)}</span></div>
                            <div><span class="stat-label">å¤§å•</span><br><span class="${flow.large_net >= 0 ? 'price-up' : 'price-down'}">${formatFlow(flow.large_net)}</span></div>
                            <div><span class="stat-label">ä¸­å•</span><br><span class="${flow.medium_net >= 0 ? 'price-up' : 'price-down'}">${formatFlow(flow.medium_net)}</span></div>
                        </div>
                    ` : ''}
                `;

                // Draw detail chart
                if (flow) {
                    setTimeout(() => {
                        const detailChart = echarts.init(document.getElementById('detailChart'));
                        detailChart.setOption({
                            backgroundColor: 'transparent',
                            tooltip: { trigger: 'axis' },
                            xAxis: {
                                type: 'category',
                                data: ['è¶…å¤§å•', 'å¤§å•', 'ä¸­å•', 'å°å•'],
                                axisLine: { lineStyle: { color: '#2d2d5a' } },
                                axisLabel: { color: '#a0a0a0' }
                            },
                            yAxis: {
                                type: 'value',
                                axisLine: { lineStyle: { color: '#2d2d5a' } },
                                axisLabel: { color: '#a0a0a0' },
                                splitLine: { lineStyle: { color: '#2d2d5a' } }
                            },
                            series: [{
                                type: 'bar',
                                data: [
                                    { value: flow.super_large_net / 10000, itemStyle: { color: flow.super_large_net >= 0 ? '#ef4444' : '#10b981' } },
                                    { value: flow.large_net / 10000, itemStyle: { color: flow.large_net >= 0 ? '#ef4444' : '#10b981' } },
                                    { value: flow.medium_net / 10000, itemStyle: { color: flow.medium_net >= 0 ? '#ef4444' : '#10b981' } },
                                    { value: flow.small_net / 10000, itemStyle: { color: flow.small_net >= 0 ? '#ef4444' : '#10b981' } }
                                ],
                                barWidth: '50%'
                            }]
                        });
                    }, 100);
                }
            }
        }

        function formatAmount(amount) {
            if (!amount) return '--';
            if (amount >= 100000000) {
                return (amount / 100000000).toFixed(2) + 'äº¿';
            }
            if (amount >= 10000) {
                return (amount / 10000).toFixed(2) + 'ä¸‡';
            }
            return amount.toFixed(2);
        }

        function formatFlow(value) {
            if (!value) return '--';
            const absValue = Math.abs(value);
            if (absValue >= 10000) {
                return (value / 10000).toFixed(2) + 'äº¿';
            }
            return value.toFixed(2) + 'ä¸‡';
        }

        // AI Analysis
        async function analyzeStock() {
            const code = document.getElementById('analysisStockCode').value.trim();
            if (!code) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            document.getElementById('stockAnalysisResult').innerHTML = `
                <div class="ai-loading">
                    <div class="spinner"></div>
                    <span>AI æ­£åœ¨åˆ†æä¸­...</span>
                </div>
            `;

            const result = await apiCall(`/api/analysis/stock/${code}`);
            if (result.success && result.data) {
                const analysis = result.data.analysis || 'åˆ†æå¤±è´¥';
                document.getElementById('stockAnalysisResult').innerHTML = marked.parse(analysis);
            } else {
                document.getElementById('stockAnalysisResult').innerHTML = `<p>åˆ†æå¤±è´¥ï¼š${result.detail || result.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
            }
        }

        async function analyzeMarket() {
            document.getElementById('marketAnalysisResult').innerHTML = `
                <div class="ai-loading">
                    <div class="spinner"></div>
                    <span>AI æ­£åœ¨åˆ†æå¸‚åœº...</span>
                </div>
            `;

            const result = await apiCall('/api/analysis/market');
            if (result.success && result.data) {
                const analysis = result.data.analysis || 'åˆ†æå¤±è´¥';
                document.getElementById('marketAnalysisResult').innerHTML = marked.parse(analysis);
            } else {
                document.getElementById('marketAnalysisResult').innerHTML = `<p>åˆ†æå¤±è´¥ï¼š${result.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
            }
        }

        async function generateDailySummary() {
            document.getElementById('dailySummaryResult').innerHTML = `
                <div class="ai-loading">
                    <div class="spinner"></div>
                    <span>AI æ­£åœ¨ç”Ÿæˆæ¯æ—¥æ€»ç»“...</span>
                </div>
            `;

            const result = await apiCall('/api/analysis/daily-summary');
            if (result.success && result.data) {
                let summaryData = result.data.summary;
                
                // å°è¯•è§£æJSON string
                if (typeof summaryData === 'string') {
                    try {
                        // æ¸…ç†å¯èƒ½å­˜åœ¨çš„markdownä»£ç å—æ ‡è®°
                        const cleanJson = summaryData.replace(/```json\n?|```/g, '').trim();
                        summaryData = JSON.parse(cleanJson);
                    } catch (e) {
                        // å¦‚æœè§£æå¤±è´¥ï¼Œå›é€€åˆ°æ™®é€šMarkdownæ˜¾ç¤º
                        document.getElementById('dailySummaryResult').innerHTML = marked.parse(summaryData);
                        return;
                    }
                }

                // æ¸²æŸ“ç»“æ„åŒ–æ•°æ®
                const html = `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: var(--accent-blue); margin-bottom: 0.5rem;">ğŸ“Š å¸‚åœºæ¦‚è§ˆ</h4>
                        <p style="color: var(--text-primary); margin-bottom: 1rem;">${summaryData.market_overview}</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            ${summaryData.indices_analysis ? summaryData.indices_analysis.map(idx => `
                                <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px;">
                                    <div style="font-weight: bold; margin-bottom: 0.25rem;">${idx.name}</div>
                                    <div style="font-size: 0.85rem; color: ${idx.change.includes('-') || idx.change.includes('è·Œ') ? 'var(--accent-green)' : 'var(--accent-red)'}">${idx.change}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">${idx.analysis}</div>
                                </div>
                            `).join('') : ''}
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: var(--accent-purple); margin-bottom: 0.5rem;">â­ å…³æ³¨åˆ—è¡¨è¡¨ç°</h4>
                        <p style="color: var(--text-secondary);">${summaryData.watch_list_summary}</p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: var(--accent-red); margin-bottom: 0.5rem;">ğŸ”¥ å€¼å¾—å…³æ³¨</h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            ${summaryData.hot_stocks ? summaryData.hot_stocks.map(stock => `
                                <div style="background: rgba(239, 68, 68, 0.1); border-left: 3px solid var(--accent-red); padding: 0.5rem 1rem;">
                                    <div style="font-weight: bold;">${stock.name} <span style="font-size: 0.85rem; color: var(--text-secondary);">(${stock.code})</span></div>
                                    <div style="font-size: 0.9rem;">${stock.reason}</div>
                                </div>
                            `).join('') : '<p>æ— ç‰¹åˆ«å…³æ³¨</p>'}
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div>
                            <h4 style="color: var(--accent-blue); margin-bottom: 0.5rem;">ğŸ“… æ˜æ—¥å…³æ³¨</h4>
                            <p style="font-size: 0.95rem; line-height: 1.6;">${summaryData.focus_tomorrow}</p>
                        </div>
                        <div>
                            <h4 style="color: var(--accent-yellow); margin-bottom: 0.5rem;">âš ï¸ é£é™©æç¤º</h4>
                            <p style="font-size: 0.95rem; line-height: 1.6;">${summaryData.risks}</p>
                        </div>
                    </div>
                `;

                document.getElementById('dailySummaryResult').innerHTML = html;
            } else {
                document.getElementById('dailySummaryResult').innerHTML = `<p>${result.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¡®ä¿å…³æ³¨åˆ—è¡¨ä¸ä¸ºç©º'}</p>`;
            }
        }

        // Load stock news
        async function loadStockNews() {
            const code = document.getElementById('newsStockCode').value.trim();
            if (!code) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            document.getElementById('newsList').innerHTML = `
                <div class="ai-loading">
                    <div class="spinner"></div>
                    <span>åŠ è½½æ–°é—»å¹¶åˆ†ææƒ…ç»ªä¸­...</span>
                </div>
            `;

            const result = await apiCall(`/api/analysis/news/${code}?analyze=false&limit=10&sentiment_analysis=true`);
            if (result.success && result.data && result.data.news && result.data.news.length > 0) {
                // æƒ…ç»ªæ‘˜è¦
                let sentimentSummary = '';
                if (result.data.sentiment_summary) {
                    const summary = result.data.sentiment_summary;
                    const scoreColor = summary.overall_score >= 0.6 ? '#52c41a' :
                                      summary.overall_score >= 0.4 ? '#faad14' : '#f5222d';

                    sentimentSummary = `
                        <div class="metric-card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, rgba(82, 196, 26, 0.1), rgba(24, 144, 255, 0.1));">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary);">ğŸ“Š æ–°é—»æƒ…ç»ªåˆ†æ (åŸºäº50æ¡æ–°é—»)</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">æ•´ä½“æƒ…ç»ª</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: ${scoreColor};">
                                        ${summary.overall_label} (${(summary.overall_score * 100).toFixed(1)}åˆ†)
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">ç§¯æ</div>
                                    <div style="font-size: 1.25rem; font-weight: bold; color: #52c41a;">
                                        ${summary.positive_count} (${(summary.positive_ratio * 100).toFixed(1)}%)
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">ä¸­æ€§</div>
                                    <div style="font-size: 1.25rem; font-weight: bold; color: #faad14;">
                                        ${summary.neutral_count} (${(summary.neutral_ratio * 100).toFixed(1)}%)
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">æ¶ˆæ</div>
                                    <div style="font-size: 1.25rem; font-weight: bold; color: #f5222d;">
                                        ${summary.negative_count} (${(summary.negative_ratio * 100).toFixed(1)}%)
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // æ–°é—»åˆ—è¡¨
                const newsHtml = result.data.news.map(news => {
                    let sentimentBadge = '';
                    if (news.sentiment) {
                        const s = news.sentiment;
                        const badgeColor = s.label === 'ç§¯æ' ? '#52c41a' :
                                          s.label === 'æ¶ˆæ' ? '#f5222d' : '#faad14';
                        sentimentBadge = `
                            <span style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px;
                                         background-color: ${badgeColor}22; color: ${badgeColor};
                                         font-size: 0.75rem; font-weight: bold; margin-right: 0.5rem;">
                                ${s.label}
                            </span>
                        `;
                    }

                    return `
                        <div class="news-item" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                            <div style="flex: 1; cursor: pointer;" onclick="window.open('${news.url}', '_blank')">
                                <div class="news-title" style="color: var(--accent-blue); text-decoration: none;">
                                    ${sentimentBadge}${news.title}
                                </div>
                                <div class="news-meta">
                                    <span>${news.source || 'ä¸œæ–¹è´¢å¯Œ'}</span>
                                    <span> Â· </span>
                                    <span>${news.date || ''}</span>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); analyzeNews('${encodeURIComponent(news.title)}', '${encodeURIComponent(news.content || '')}')" style="flex-shrink: 0; white-space: nowrap;">
                                ğŸ¤– AIåˆ†æ
                            </button>
                        </div>
                    `;
                }).join('');

                document.getElementById('newsList').innerHTML = sentimentSummary + newsHtml;
            } else {
                document.getElementById('newsList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“°</div>
                        <p>æš‚æ— ç›¸å…³æ–°é—»</p>
                    </div>
                `;
            }
        }

        async function analyzeNews(title, content) {
            document.getElementById('stockAnalysisResult').innerHTML = `
                <div class="ai-loading">
                    <div class="spinner"></div>
                    <span>AI æ­£åœ¨è§£è¯»æ–°é—»...</span>
                </div>
            `;

            const result = await apiCall('/api/analysis/news', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: decodeURIComponent(title),
                    content: decodeURIComponent(content),
                    stock_name: ''
                })
            });

            if (result.success && result.data) {
                document.getElementById('stockAnalysisResult').innerHTML = `
                    <h4 style="margin-bottom: 1rem; color: var(--accent-blue);">${decodeURIComponent(title)}</h4>
                    ${marked.parse(result.data.analysis || 'è§£è¯»å¤±è´¥')}
                `;
                // Auto scroll to the result
                document.getElementById('stockAnalysisResult').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                document.getElementById('stockAnalysisResult').innerHTML = `<p>è§£è¯»å¤±è´¥</p>`;
            }
        }

        // ============ èˆ†æƒ…æŒ‡æ•°æ¨¡å— ============

        async function loadMarketSentiment() {
            const category = document.getElementById('sentimentCategory').value;
            const container = document.getElementById('marketSentimentContent');

            container.innerHTML = `
                <div class="ai-loading">
                    <div class="spinner"></div>
                    <span>æ­£åœ¨åˆ†æå¸‚åœºèˆ†æƒ…...</span>
                </div>
            `;

            const result = await apiCall(`/api/analysis/sentiment/index?category=${category}&count=100`);

            if (result.success && result.data) {
                const data = result.data;
                const level = data.level_info;
                const dist = data.distribution;
                const trend = data.trend;

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                        <!-- èˆ†æƒ…æŒ‡æ•°ä»ªè¡¨ç›˜ -->
                        <div class="metric-card" style="text-align: center; padding: 2rem; background: linear-gradient(135deg, ${level.color}11, ${level.color}22);">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;">${level.icon}</div>
                            <div style="font-size: 3rem; font-weight: bold; color: ${level.color};">${level.index}</div>
                            <div style="font-size: 1.25rem; color: ${level.color}; margin-bottom: 0.5rem;">${level.level}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                åŸºäº ${data.total_news} æ¡æ–°é—»åˆ†æ
                            </div>
                        </div>

                        <!-- æƒ…ç»ªåˆ†å¸ƒ -->
                        <div class="metric-card">
                            <h4 style="margin-bottom: 1rem;">æƒ…ç»ªåˆ†å¸ƒ</h4>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 60px; color: #52c41a;">ç§¯æ</div>
                                    <div style="flex: 1; height: 24px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                        <div style="width: ${dist.positive.ratio * 100}%; height: 100%; background: #52c41a;"></div>
                                    </div>
                                    <div style="width: 80px; text-align: right;">${dist.positive.count} (${(dist.positive.ratio * 100).toFixed(1)}%)</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 60px; color: #faad14;">ä¸­æ€§</div>
                                    <div style="flex: 1; height: 24px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                        <div style="width: ${dist.neutral.ratio * 100}%; height: 100%; background: #faad14;"></div>
                                    </div>
                                    <div style="width: 80px; text-align: right;">${dist.neutral.count} (${(dist.neutral.ratio * 100).toFixed(1)}%)</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 60px; color: #f5222d;">æ¶ˆæ</div>
                                    <div style="flex: 1; height: 24px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                        <div style="width: ${dist.negative.ratio * 100}%; height: 100%; background: #f5222d;"></div>
                                    </div>
                                    <div style="width: 80px; text-align: right;">${dist.negative.count} (${(dist.negative.ratio * 100).toFixed(1)}%)</div>
                                </div>
                            </div>
                        </div>

                        <!-- è¶‹åŠ¿åˆ†æ -->
                        <div class="metric-card">
                            <h4 style="margin-bottom: 1rem;">è¶‹åŠ¿åˆ†æ</h4>
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">
                                ${trend.direction === 'improving' ? 'ğŸ“ˆ ' : trend.direction === 'declining' ? 'ğŸ“‰ ' : 'â¡ï¸ '}
                                ${trend.description}
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.875rem;">
                                å˜åŒ–å¹…åº¦: ${trend.change > 0 ? '+' : ''}${trend.change}%
                            </div>
                            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">è¿‘æœŸå‡å€¼</div>
                                    <div style="font-size: 1.25rem; font-weight: bold;">${(trend.recent_score * 100).toFixed(1)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">æ—©æœŸå‡å€¼</div>
                                    <div style="font-size: 1.25rem; font-weight: bold;">${(trend.earlier_score * 100).toFixed(1)}</div>
                                </div>
                            </div>
                        </div>

                        <!-- çƒ­é—¨å…³é”®è¯ -->
                        <div class="metric-card">
                            <h4 style="margin-bottom: 1rem;">çƒ­é—¨å…³é”®è¯</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${data.keywords.map(kw => `
                                    <span style="padding: 0.25rem 0.75rem; background: var(--bg-tertiary);
                                                 border-radius: 12px; font-size: 0.875rem;">
                                        ${kw.word} <span style="color: var(--text-secondary);">(${kw.count})</span>
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- ç§¯æ/æ¶ˆææ–°é—» -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem;">
                        <div class="metric-card">
                            <h4 style="margin-bottom: 1rem; color: #52c41a;">ğŸ“° æœ€ç§¯ææ–°é—»</h4>
                            ${data.top_positive.map(n => `
                                <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); cursor: pointer;"
                                     onclick="window.open('${n.url}', '_blank')">
                                    <div style="font-size: 0.875rem; margin-bottom: 0.25rem;">${n.title}</div>
                                    <div style="font-size: 0.75rem; color: #52c41a;">
                                        æƒ…ç»ªå¾—åˆ†: ${(n.sentiment.score * 100).toFixed(1)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="metric-card">
                            <h4 style="margin-bottom: 1rem; color: #f5222d;">ğŸ“° æœ€æ¶ˆææ–°é—»</h4>
                            ${data.top_negative.map(n => `
                                <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); cursor: pointer;"
                                     onclick="window.open('${n.url}', '_blank')">
                                    <div style="font-size: 0.875rem; margin-bottom: 0.25rem;">${n.title}</div>
                                    <div style="font-size: 0.75rem; color: #f5222d;">
                                        æƒ…ç»ªå¾—åˆ†: ${(n.sentiment.score * 100).toFixed(1)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div style="margin-top: 1rem; font-size: 0.75rem; color: var(--text-secondary); text-align: right;">
                        æ›´æ–°æ—¶é—´: ${new Date(data.timestamp).toLocaleString()}
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âŒ</div>
                        <p>è·å–èˆ†æƒ…æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
                    </div>
                `;
            }
        }

        async function loadStockSentiment() {
            const code = document.getElementById('stockSentimentInput').value.trim();
            if (!code) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            const container = document.getElementById('stockSentimentContent');
            container.innerHTML = `
                <div class="ai-loading">
                    <div class="spinner"></div>
                    <span>æ­£åœ¨åˆ†æä¸ªè‚¡èˆ†æƒ…...</span>
                </div>
            `;

            const result = await apiCall(`/api/analysis/sentiment/stock/${code}?count=50`);

            if (result.success && result.data) {
                const data = result.data;
                const level = data.level_info;

                container.innerHTML = `
                    <div class="metric-card" style="background: linear-gradient(135deg, ${level.color}11, ${level.color}22);">
                        <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;">${level.icon}</div>
                                <div style="font-size: 2.5rem; font-weight: bold; color: ${level.color};">${level.index}</div>
                                <div style="color: ${level.color};">${level.level}</div>
                            </div>
                            <div style="flex: 1;">
                                <h3 style="margin-bottom: 0.5rem;">${data.name} (${data.code})</h3>
                                <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                                    åŸºäº ${data.total_news} æ¡æ–°é—»åˆ†æ
                                </div>
                                <div style="display: flex; gap: 1rem;">
                                    <span style="color: #52c41a;">ç§¯æ: ${data.distribution.positive.count}</span>
                                    <span style="color: #faad14;">ä¸­æ€§: ${data.distribution.neutral.count}</span>
                                    <span style="color: #f5222d;">æ¶ˆæ: ${data.distribution.negative.count}</span>
                                </div>
                            </div>
                        </div>

                        <!-- æ–°é—»åˆ—è¡¨ -->
                        <h4 style="margin-bottom: 1rem;">ç›¸å…³æ–°é—»</h4>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${data.news_sentiments.map(n => {
                                const sentColor = n.sentiment.label === 'ç§¯æ' ? '#52c41a' :
                                                 n.sentiment.label === 'æ¶ˆæ' ? '#f5222d' : '#faad14';
                                return `
                                    <div style="padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); cursor: pointer;"
                                         onclick="window.open('${n.url}', '_blank')">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                            <span style="padding: 0.125rem 0.5rem; border-radius: 4px;
                                                         background: ${sentColor}22; color: ${sentColor};
                                                         font-size: 0.75rem;">${n.sentiment.label}</span>
                                            <span style="font-size: 0.75rem; color: var(--text-secondary);">${n.date}</span>
                                        </div>
                                        <div style="font-size: 0.875rem;">${n.title}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âŒ</div>
                        <p>è·å–ä¸ªè‚¡èˆ†æƒ…å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}</p>
                    </div>
                `;
            }
        }

        async function compareSentiment() {
            const codes = document.getElementById('sentimentCompareInput').value.trim();
            if (!codes) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            const container = document.getElementById('sentimentCompareContent');
            container.innerHTML = `
                <div class="ai-loading">
                    <div class="spinner"></div>
                    <span>æ­£åœ¨å¯¹æ¯”èˆ†æƒ…...</span>
                </div>
            `;

            const result = await apiCall(`/api/analysis/sentiment/compare?codes=${encodeURIComponent(codes)}`);

            if (result.success && result.data && result.data.stocks) {
                const stocks = result.data.stocks;

                container.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--bg-tertiary);">
                                    <th style="padding: 0.75rem; text-align: left;">æ’å</th>
                                    <th style="padding: 0.75rem; text-align: left;">è‚¡ç¥¨</th>
                                    <th style="padding: 0.75rem; text-align: center;">èˆ†æƒ…æŒ‡æ•°</th>
                                    <th style="padding: 0.75rem; text-align: center;">ç­‰çº§</th>
                                    <th style="padding: 0.75rem; text-align: center;">ç§¯ææ¯”ä¾‹</th>
                                    <th style="padding: 0.75rem; text-align: center;">æ¶ˆææ¯”ä¾‹</th>
                                    <th style="padding: 0.75rem; text-align: center;">è¶‹åŠ¿</th>
                                    <th style="padding: 0.75rem; text-align: center;">æ–°é—»æ•°</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${stocks.map((s, i) => `
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 0.75rem;">
                                            ${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : i + 1}
                                        </td>
                                        <td style="padding: 0.75rem;">
                                            <strong>${s.name}</strong>
                                            <span style="color: var(--text-secondary); font-size: 0.875rem;">(${s.code})</span>
                                        </td>
                                        <td style="padding: 0.75rem; text-align: center;">
                                            <span style="font-size: 1.25rem; font-weight: bold; color: ${s.color};">${s.index}</span>
                                        </td>
                                        <td style="padding: 0.75rem; text-align: center;">
                                            <span style="color: ${s.color};">${s.icon} ${s.level}</span>
                                        </td>
                                        <td style="padding: 0.75rem; text-align: center; color: #52c41a;">
                                            ${(s.positive_ratio * 100).toFixed(1)}%
                                        </td>
                                        <td style="padding: 0.75rem; text-align: center; color: #f5222d;">
                                            ${(s.negative_ratio * 100).toFixed(1)}%
                                        </td>
                                        <td style="padding: 0.75rem; text-align: center;">
                                            ${s.trend === 'improving' ? 'ğŸ“ˆ' : s.trend === 'declining' ? 'ğŸ“‰' : 'â¡ï¸'}
                                        </td>
                                        <td style="padding: 0.75rem; text-align: center;">${s.news_count}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âŒ</div>
                        <p>èˆ†æƒ…å¯¹æ¯”å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}</p>
                    </div>
                `;
            }
        }

        function fillSentimentFromWatchlist() {
            // ä»å…³æ³¨åˆ—è¡¨å¡«å……è‚¡ç¥¨ä»£ç 
            apiCall('/api/watchlist').then(result => {
                if (result.success && result.data && result.data.length > 0) {
                    const codes = result.data.slice(0, 5).map(s => s.code).join(',');
                    document.getElementById('sentimentCompareInput').value = codes;
                } else {
                    alert('å…³æ³¨åˆ—è¡¨ä¸ºç©º');
                }
            });
        }

        // Alerts
        async function loadAlerts() {
            const result = await apiCall('/api/alerts?limit=50');
            if (result.success && result.data && result.data.length > 0) {
                const alertsHtml = result.data.map(alert => {
                    const isUp = alert.alert_type === 'price_up' || alert.alert_type === 'consecutive_up';
                    return `
                        <div class="alert-item">
                            <div class="alert-icon ${isUp ? 'up' : 'down'}">
                                ${isUp ? 'ğŸ“ˆ' : 'ğŸ“‰'}
                            </div>
                            <div class="alert-info">
                                <div class="alert-message">${alert.message}</div>
                                <div class="alert-time">${new Date(alert.triggered_at).toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('alertsList').innerHTML = alertsHtml;
            } else {
                document.getElementById('alertsList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ””</div>
                        <p>æš‚æ— æé†’è®°å½•</p>
                    </div>
                `;
            }
        }

        async function checkAlerts() {
            const result = await apiCall('/api/alerts/check', { method: 'POST' });
            if (result.success) {
                loadAlerts();
                if (result.data && result.data.triggered_count > 0) {
                    alert(`è§¦å‘äº† ${result.data.triggered_count} æ¡æé†’ï¼`);
                } else {
                    alert('æœªè§¦å‘ä»»ä½•æé†’');
                }
            }
        }

        async function clearAlerts() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æé†’è®°å½•å—ï¼Ÿ')) return;
            const result = await apiCall('/api/alerts', { method: 'DELETE' });
            if (result.success) {
                loadAlerts();
            }
        }

        // Load trading status
        async function loadTradingStatus() {
            const result = await apiCall('/api/stocks/trading-status');
            if (result.success && result.data) {
                const status = result.data;
                const badge = document.getElementById('connectionStatus');

                if (status.is_trading) {
                    badge.textContent = 'äº¤æ˜“ä¸­';
                    badge.style.color = 'var(--accent-green)';
                } else {
                    const lastDay = new Date(status.last_trading_day).toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                    badge.textContent = `ä¼‘å¸‚ï¼ˆæ˜¾ç¤º${lastDay}æ•°æ®ï¼‰`;
                    badge.style.color = 'var(--accent-yellow)';
                }
            }
        }

        // Load default indices
        async function loadDefaultIndices() {
            const result = await apiCall('/api/stocks/indices/default');
            if (!result.success || !result.data) return;

            const html = result.data.map(idx => {
                const isUp = idx.change_percent >= 0;
                const color = isUp ? 'var(--accent-red)' : 'var(--accent-green)';
                return `
                    <div class="index-item">
                        <div class="index-name">${idx.name}</div>
                        <div class="index-price">${idx.price.toFixed(2)}</div>
                        <div class="index-change" style="color: ${color}">
                            ${isUp ? 'â–²' : 'â–¼'} ${Math.abs(idx.change).toFixed(2)}
                            (${idx.change_percent.toFixed(2)}%)
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('indicesGrid').innerHTML = html;
            document.getElementById('indicesUpdateTime').textContent = new Date().toLocaleTimeString();
        }

        // Load commodities
        async function loadCommodities() {
            const result = await apiCall('/api/stocks/commodities');
            if (!result.success || !result.data) return;

            const html = result.data.map(commodity => {
                const isUp = commodity.change_percent >= 0;
                const color = isUp ? 'var(--accent-red)' : 'var(--accent-green)';
                return `
                    <div class="commodity-item">
                        <div>
                            <div class="commodity-name">${commodity.name}</div>
                            <div class="commodity-code">${commodity.code.toUpperCase()}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="commodity-price">${commodity.price.toFixed(2)}</div>
                            <div class="commodity-unit">${commodity.unit}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: ${color}; font-weight: 600;">
                                ${isUp ? 'â–²' : 'â–¼'} ${commodity.change_percent.toFixed(2)}%
                            </div>
                            <div style="color: ${color}; font-size: 0.85rem;">
                                ${commodity.change.toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('commoditiesList').innerHTML = html;
            document.getElementById('commoditiesUpdateTime').textContent = new Date().toLocaleTimeString();
        }

        // Correlation analysis
        let turnoverChart, amplitudeChart, ma5Chart;

        function fillCorrelationInput1(value) {
            if (!value) return;
            document.getElementById('corrCode1').value = value;
            // Reset the select
            document.getElementById('watchListSelect1').value = '';
        }

        function fillCorrelationInput2(value) {
            if (!value) return;
            document.getElementById('corrCode2').value = value;
            // Reset the select
            document.getElementById('watchListSelect2').value = '';
        }

        // Legacy function for backward compatibility
        function fillCorrelationInput(value) {
            if (!value) return;
            const input1 = document.getElementById('corrCode1');
            const input2 = document.getElementById('corrCode2');

            if (!input1.value) {
                input1.value = value;
            } else if (!input2.value) {
                input2.value = value;
            } else {
                // If both full, replace the second one
                input2.value = value;
            }
        }

        async function loadWatchListForCorrelation() {
            const result = await apiCall('/api/stocks/watch-list');
            if (result.success && result.data) {
                // Update both select elements
                const select1 = document.getElementById('watchListSelect1');
                const select2 = document.getElementById('watchListSelect2');

                // Keep first option and populate
                select1.innerHTML = '<option value="">-- ä»å…³æ³¨åˆ—è¡¨é€‰æ‹© --</option>';
                select2.innerHTML = '<option value="">-- ä»å…³æ³¨åˆ—è¡¨é€‰æ‹© --</option>';

                result.data.forEach(item => {
                    const opt1 = document.createElement('option');
                    opt1.value = item.code;
                    opt1.textContent = `${item.name} (${item.code})`;
                    select1.appendChild(opt1);

                    const opt2 = document.createElement('option');
                    opt2.value = item.code;
                    opt2.textContent = `${item.name} (${item.code})`;
                    select2.appendChild(opt2);
                });
            }
        }

        async function analyzeCorrelation() {
            const code1 = document.getElementById('corrCode1').value.trim();
            const code2 = document.getElementById('corrCode2').value.trim();
            const days = parseInt(document.getElementById('corrDays').value);

            if (!code1 || !code2) {
                alert('è¯·è¾“å…¥ä¸¤ä¸ªè‚¡ç¥¨/æŒ‡æ•°/å®è§‚ä»£ç ');
                return;
            }

            const indicators = Array.from(
                document.querySelectorAll('.corr-indicator:checked')
            ).map(cb => cb.value);

            // If macro, indicators are ignored anyway
            
            // Show loading state
            const btn = document.querySelector('#correlation .btn-primary');
            const originalText = btn.textContent;
            btn.textContent = 'åˆ†æä¸­...';
            btn.disabled = true;

            const result = await apiCall('/api/analysis/correlation', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({code1, code2, days, indicators})
            });
            
            btn.textContent = originalText;
            btn.disabled = false;

            if (!result.success) {
                alert(result.message || 'åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç æ˜¯å¦æ­£ç¡®æˆ–æ•°æ®æºæ˜¯å¦å¯ç”¨');
                return;
            }

            displayCorrelationResults(result.data);
        }

        function displayCorrelationResults(data) {
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('correlationResults').style.display = 'block';

            // æ¸²æŸ“ç›¸å…³æ€§çŸ©é˜µ
            const matrixHtml = Object.entries(data.correlation_matrix).map(([key, val]) => {
                return `
                    <div class="correlation-item">
                        <span>${val.description}</span>
                        <div>
                            <span class="correlation-value" style="color: ${val.color}">
                                ${val.value.toFixed(3)}
                            </span>
                            <span class="correlation-badge" style="background: ${val.color}33; color: ${val.color}">
                                ${val.level}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('correlationMatrix').innerHTML = matrixHtml;

            // æ¸²æŸ“å›¾è¡¨
            renderComparisonCharts(data);
        }

        function renderComparisonCharts(data) {
            const dates = data.time_series.map(d => d.date);
            const isMacro = data.correlation_matrix.hasOwnProperty('monthly_value');

            // å¦‚æœæ˜¯å®è§‚æ•°æ®åˆ†æï¼Œéšè—æ— å…³å›¾è¡¨
            const standardCharts = document.getElementById('standardCharts');
            if (isMacro) {
                standardCharts.style.display = 'none';
            } else {
                standardCharts.style.display = 'grid';
                
                // æ¢æ‰‹ç‡å¯¹æ¯”å›¾
                if (!turnoverChart) {
                    turnoverChart = echarts.init(document.getElementById('turnoverChart'));
                } else {
                    turnoverChart.clear();  // æ¸…é™¤æ—§æ•°æ®
                }
                turnoverChart.setOption({
                    tooltip: {trigger: 'axis'},
                    legend: {data: [data.name1, data.name2], textStyle: {color: '#e8e8e8'}},
                    xAxis: {type: 'category', data: dates, axisLabel: {color: '#a0a0a0'}},
                    yAxis: {type: 'value', name: 'æ¢æ‰‹ç‡(%)', nameTextStyle: {color: '#a0a0a0'}, axisLabel: {color: '#a0a0a0'}},
                    backgroundColor: 'transparent',
                    series: [
                        {
                            name: data.name1,
                            type: 'line',
                            data: data.time_series.map(d => d.code1.turnover_rate),
                            smooth: true,
                            itemStyle: {color: '#4facfe'}
                        },
                        {
                            name: data.name2,
                            type: 'line',
                            data: data.time_series.map(d => d.code2.turnover_rate),
                            smooth: true,
                            itemStyle: {color: '#f5576c'}
                        }
                    ]
                });

                // æŒ¯å¹…å¯¹æ¯”å›¾
                if (!amplitudeChart) {
                    amplitudeChart = echarts.init(document.getElementById('amplitudeChart'));
                } else {
                    amplitudeChart.clear();  // æ¸…é™¤æ—§æ•°æ®
                }
                amplitudeChart.setOption({
                    tooltip: {trigger: 'axis'},
                    legend: {data: [data.name1, data.name2], textStyle: {color: '#e8e8e8'}},
                    xAxis: {type: 'category', data: dates, axisLabel: {color: '#a0a0a0'}},
                    yAxis: {type: 'value', name: 'æŒ¯å¹…(%)', nameTextStyle: {color: '#a0a0a0'}, axisLabel: {color: '#a0a0a0'}},
                    backgroundColor: 'transparent',
                    series: [
                        {
                            name: data.name1,
                            type: 'line',
                            data: data.time_series.map(d => d.code1.amplitude),
                            smooth: true,
                            itemStyle: {color: '#4facfe'}
                        },
                        {
                            name: data.name2,
                            type: 'line',
                            data: data.time_series.map(d => d.code2.amplitude),
                            smooth: true,
                            itemStyle: {color: '#f5576c'}
                        }
                    ]
                });
            }

            // è¶‹åŠ¿/MA5/Valueå¯¹æ¯”å›¾ï¼ˆåŒYè½´ï¼‰
            if (!ma5Chart) {
                ma5Chart = echarts.init(document.getElementById('ma5Chart'));
            } else {
                ma5Chart.clear();  // æ¸…é™¤æ—§æ•°æ®
            }

            // é‡æ–°è®¾ç½®å¤§å°ä»¥é€‚åº”å®¹å™¨å˜åŒ–
            ma5Chart.resize();

            const ma5Data1 = data.time_series.map(d => d.code1.ma5).filter(v => v !== null && v !== undefined);
            const ma5Data2 = data.time_series.map(d => d.code2.ma5).filter(v => v !== null && v !== undefined);
            const ma5Dates = dates.slice(-ma5Data1.length); // Assuming alignment aligns to end

            // Update title based on mode
            const chartTitle = isMacro ? 'æœˆåº¦æ•°å€¼å¯¹æ¯”' : '5æ—¥å‡ä»·å¯¹æ¯”';
            document.querySelector('#ma5Chart').previousElementSibling.querySelector('h3').textContent = chartTitle;

            ma5Chart.setOption({
                tooltip: {trigger: 'axis'},
                legend: {data: [data.name1, data.name2], textStyle: {color: '#e8e8e8'}},
                xAxis: {type: 'category', data: dates, axisLabel: {color: '#a0a0a0'}},
                yAxis: [
                    {type: 'value', name: data.name1, position: 'left', nameTextStyle: {color: '#4facfe'}, axisLabel: {color: '#a0a0a0'}, scale: true},
                    {type: 'value', name: data.name2, position: 'right', nameTextStyle: {color: '#f5576c'}, axisLabel: {color: '#a0a0a0'}, scale: true}
                ],
                backgroundColor: 'transparent',
                series: [
                    {
                        name: data.name1,
                        type: 'line',
                        data: data.time_series.map(d => d.code1.ma5), // Using 'ma5' field for value in macro mode too
                        smooth: true,
                        yAxisIndex: 0,
                        itemStyle: {color: '#4facfe'}
                    },
                    {
                        name: data.name2,
                        type: 'line',
                        data: data.time_series.map(d => d.code2.ma5),
                        smooth: true,
                        yAxisIndex: 1,
                        itemStyle: {color: '#f5576c'}
                    }
                ]
            });
        }

        // Refresh all data
        function refreshAll() {
            loadTradingStatus();
            loadDefaultIndices();
            loadCommodities();
            loadMarketSentiment();
            loadGroups();
            loadWatchListQuotes();
            loadAlerts();
            loadWatchListForCorrelation();
            loadNorthFlowChart();
        }

        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.input-group')) {
                document.getElementById('searchResults').classList.remove('show');
            }
        });

        // ============ æŒä»“ç®¡ç† ============
        let currentPositions = [];

        async function loadPortfolio() {
            await loadPortfolioSummary();
            await loadPositions();
            await loadTransactions();
        }

        async function loadPortfolioSummary() {
            try {
                const result = await apiCall('/api/portfolio/summary');
                if (result.success && result.data) {
                    const data = result.data;
                    document.getElementById('pfTotalCurrent').textContent = formatMoney(data.total_current);
                    document.getElementById('pfTotalCost').textContent = formatMoney(data.total_cost);

                    const profitEl = document.getElementById('pfTotalProfit');
                    const profitCard = document.getElementById('pfProfitCard');
                    const profitPercent = document.getElementById('pfProfitPercent');

                    profitEl.textContent = (data.total_profit >= 0 ? '+' : '') + formatMoney(data.total_profit);
                    profitPercent.textContent = (data.total_profit_percent >= 0 ? '+' : '') + data.total_profit_percent.toFixed(2) + '%';

                    if (data.total_profit >= 0) {
                        profitEl.className = 'stat-value green';
                        profitCard.className = 'stat-card green';
                    } else {
                        profitEl.className = 'stat-value red';
                        profitCard.className = 'stat-card red';
                    }

                    document.getElementById('pfCounts').textContent = `${data.position_count} / ${data.profit_count} / ${data.loss_count}`;
                }
            } catch (error) {
                console.error('åŠ è½½æŒä»“æ±‡æ€»å¤±è´¥:', error);
            }
        }

        async function loadPositions() {
            const container = document.getElementById('positionsList');
            try {
                const result = await apiCall('/api/portfolio/positions');
                if (result.success && result.data) {
                    currentPositions = result.data.positions;
                    updateSellSelect();

                    if (currentPositions.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state" style="padding: 1rem;">
                                <div class="empty-icon">ğŸ’¼</div>
                                <p>æš‚æ— æŒä»“ï¼Œè¯·å…ˆä¹°å…¥è‚¡ç¥¨</p>
                            </div>
                        `;
                        return;
                    }

                    let html = '';
                    currentPositions.forEach(pos => {
                        const profitColor = pos.profit >= 0 ? 'price-up' : 'price-down';
                        const profitSign = pos.profit >= 0 ? '+' : '';
                        html += `
                            <div class="position-item" onclick="showStockDetail('${pos.code}')">
                                <div class="position-info">
                                    <div class="position-name">${pos.name}</div>
                                    <div class="position-code">${pos.code}</div>
                                </div>
                                <div class="position-detail">
                                    <div class="position-quantity">${pos.quantity}è‚¡</div>
                                    <div class="position-cost">æˆæœ¬ ${pos.cost_price.toFixed(2)} | ç°ä»· ${pos.current_price.toFixed(2)}</div>
                                </div>
                                <div class="position-profit">
                                    <div class="position-profit-amount ${profitColor}">${profitSign}${pos.profit.toFixed(2)}</div>
                                    <div class="position-profit-percent ${profitColor}">${profitSign}${pos.profit_percent.toFixed(2)}%</div>
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>åŠ è½½å¤±è´¥</p></div>';
            }
        }

        async function loadTransactions() {
            const container = document.getElementById('transactionsList');
            try {
                const result = await apiCall('/api/portfolio/transactions?limit=20');
                if (result.success && result.data && result.data.transactions.length > 0) {
                    let html = '';
                    result.data.transactions.forEach(tx => {
                        const typeClass = tx.type === 'buy' ? 'buy' : 'sell';
                        const typeText = tx.type === 'buy' ? 'ä¹°å…¥' : 'å–å‡º';
                        html += `
                            <div class="transaction-item">
                                <div class="transaction-type ${typeClass}">${typeText}</div>
                                <div class="transaction-info">
                                    <div>${tx.name} (${tx.code})</div>
                                    <div class="transaction-time">${tx.timestamp} | ${tx.quantity}è‚¡ @ ${tx.price.toFixed(2)}</div>
                                </div>
                                <div class="transaction-amount">
                                    <div>${formatMoney(tx.amount)}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">è´¹ç”¨ ${tx.fee.toFixed(2)}</div>
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>æš‚æ— äº¤æ˜“è®°å½•</p></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>åŠ è½½å¤±è´¥</p></div>';
            }
        }

        function updateSellSelect() {
            const select = document.getElementById('sellCode');
            select.innerHTML = '<option value="">é€‰æ‹©æŒä»“è‚¡ç¥¨</option>';
            currentPositions.forEach(pos => {
                select.innerHTML += `<option value="${pos.code}">${pos.name} (${pos.code}) - ${pos.quantity}è‚¡</option>`;
            });
        }

        function updateSellInfo() {
            const code = document.getElementById('sellCode').value;
            const infoEl = document.getElementById('sellInfo');
            if (!code) {
                infoEl.textContent = '';
                return;
            }
            const pos = currentPositions.find(p => p.code === code);
            if (pos) {
                infoEl.textContent = `å¯å–: ${pos.quantity}è‚¡ | æˆæœ¬: ${pos.cost_price.toFixed(2)} | ç°ä»·: ${pos.current_price.toFixed(2)}`;
            }
        }

        async function executeBuy() {
            const code = document.getElementById('buyCode').value.trim();
            const price = parseFloat(document.getElementById('buyPrice').value);
            const quantity = parseInt(document.getElementById('buyQuantity').value);
            const note = document.getElementById('buyNote').value.trim();

            if (!code || !price || !quantity) {
                alert('è¯·å¡«å†™å®Œæ•´çš„ä¹°å…¥ä¿¡æ¯');
                return;
            }

            try {
                const result = await apiCall('/api/portfolio/buy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, price, quantity, note })
                });

                if (result.success) {
                    alert(result.message);
                    document.getElementById('buyCode').value = '';
                    document.getElementById('buyPrice').value = '';
                    document.getElementById('buyQuantity').value = '';
                    document.getElementById('buyNote').value = '';
                    document.getElementById('buyFeePreview').textContent = '';
                    loadPortfolio();
                } else {
                    alert('ä¹°å…¥å¤±è´¥: ' + (result.detail || result.message));
                }
            } catch (error) {
                alert('ä¹°å…¥å¤±è´¥: ' + error.message);
            }
        }

        async function executeSell() {
            const code = document.getElementById('sellCode').value;
            const price = parseFloat(document.getElementById('sellPrice').value);
            const quantity = parseInt(document.getElementById('sellQuantity').value);

            if (!code || !price || !quantity) {
                alert('è¯·å¡«å†™å®Œæ•´çš„å–å‡ºä¿¡æ¯');
                return;
            }

            try {
                const result = await apiCall('/api/portfolio/sell', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, price, quantity })
                });

                if (result.success) {
                    alert(result.message);
                    document.getElementById('sellCode').value = '';
                    document.getElementById('sellPrice').value = '';
                    document.getElementById('sellQuantity').value = '';
                    document.getElementById('sellInfo').textContent = '';
                    loadPortfolio();
                } else {
                    alert('å–å‡ºå¤±è´¥: ' + (result.detail || result.message));
                }
            } catch (error) {
                alert('å–å‡ºå¤±è´¥: ' + error.message);
            }
        }

        function formatMoney(amount) {
            if (Math.abs(amount) >= 10000) {
                return (amount / 10000).toFixed(2) + 'ä¸‡';
            }
            return amount.toFixed(2);
        }

        // ä¹°å…¥é¢„ä¼°æ‰‹ç»­è´¹
        document.getElementById('buyPrice')?.addEventListener('input', updateBuyFee);
        document.getElementById('buyQuantity')?.addEventListener('input', updateBuyFee);

        async function updateBuyFee() {
            const price = parseFloat(document.getElementById('buyPrice').value);
            const quantity = parseInt(document.getElementById('buyQuantity').value);
            const previewEl = document.getElementById('buyFeePreview');

            if (price > 0 && quantity > 0) {
                try {
                    const result = await apiCall(`/api/portfolio/calculate-fee?price=${price}&quantity=${quantity}&is_sell=false`);
                    if (result.success) {
                        previewEl.textContent = `é¢„ä¼°: é‡‘é¢ ${result.data.amount.toFixed(2)} + æ‰‹ç»­è´¹ ${result.data.fee.toFixed(2)} = ${result.data.net_amount.toFixed(2)}`;
                    }
                } catch (e) {}
            } else {
                previewEl.textContent = '';
            }
        }

        // ============ é¾™è™æ¦œ ============
        async function loadLhbQuick() {
            const container = document.getElementById('lhbQuickList');
            container.innerHTML = '<div class="ai-loading"><div class="spinner"></div><span>åŠ è½½ä¸­...</span></div>';

            try {
                const result = await apiCall('/api/market/lhb');
                if (result.success && result.data && result.data.stocks && result.data.stocks.length > 0) {
                    const stocks = result.data.stocks.slice(0, 10);
                    let html = `
                        <div style="padding: 0.5rem; font-size: 0.85rem; color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">
                            ${result.data.date} | ä¸Šæ¦œ${result.data.count}åª | å‡€ä¹°å…¥${result.data.net_buy_stocks}åª
                        </div>
                        <div class="holdings-list">
                    `;
                    stocks.forEach((s, i) => {
                        const changeColor = (s.change_percent || 0) >= 0 ? 'price-up' : 'price-down';
                        const netBuy = ((s.net_buy || 0) / 100000000).toFixed(2);
                        const netColor = (s.net_buy || 0) >= 0 ? 'price-up' : 'price-down';
                        html += `
                            <div class="holding-item" onclick="showStockDetail('${s.code}')">
                                <div class="holding-rank">${i + 1}</div>
                                <div class="holding-info">
                                    <div class="holding-name">${s.name}</div>
                                    <div class="holding-code">${s.code}</div>
                                </div>
                                <div class="holding-stats">
                                    <div class="holding-ratio ${netColor}">å‡€${netBuy}äº¿</div>
                                    <div style="font-size: 0.7rem; color: var(--text-secondary);">${(s.reason || '').slice(0, 10)}</div>
                                </div>
                                <div class="holding-change ${changeColor}">${(s.change_percent || 0) >= 0 ? '+' : ''}${(s.change_percent || 0).toFixed(2)}%</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 1rem;">
                            <p>${result.data?.message || 'æš‚æ— é¾™è™æ¦œæ•°æ®'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>åŠ è½½å¤±è´¥</p></div>';
            }
        }

        // ============ æ¿å—åˆ†æ ============
        async function loadSectorOverview() {
            const container = document.getElementById('sectorOverview');
            container.innerHTML = '<div class="ai-loading"><div class="spinner"></div><span>åŠ è½½ä¸­...</span></div>';

            try {
                const result = await apiCall('/api/market/sectors/overview');
                if (result.success && result.data) {
                    const data = result.data;
                    let html = '<div class="sector-overview-grid">';

                    // è¡Œä¸šæ¿å—ç»Ÿè®¡
                    html += renderSectorOverviewCard('è¡Œä¸šæ¿å—', data.industry);
                    // æ¦‚å¿µæ¿å—ç»Ÿè®¡
                    html += renderSectorOverviewCard('æ¦‚å¿µæ¿å—', data.concept);

                    html += '</div>';
                    container.innerHTML = html;
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>åŠ è½½å¤±è´¥</p></div>';
            }

            // åŒæ—¶åŠ è½½è¯¦ç»†åˆ—è¡¨
            loadIndustrySectors();
            loadConceptSectors();
            loadSectorFlow();
        }

        function renderSectorOverviewCard(title, data) {
            if (!data) return '';

            const topItems = data.top3.map(s => `
                <div class="sector-top-item">
                    <span>${s.name}</span>
                    <span class="price-up">+${(s.change_percent || 0).toFixed(2)}%</span>
                </div>
            `).join('');

            const bottomItems = data.bottom3.map(s => `
                <div class="sector-top-item">
                    <span>${s.name}</span>
                    <span class="price-down">${(s.change_percent || 0).toFixed(2)}%</span>
                </div>
            `).join('');

            return `
                <div class="sector-overview-card">
                    <div class="sector-overview-title">${title}</div>
                    <div class="sector-overview-stats">
                        <div class="sector-stat">
                            <div class="sector-stat-value price-up">${data.up}</div>
                            <div class="sector-stat-label">ä¸Šæ¶¨</div>
                        </div>
                        <div class="sector-stat">
                            <div class="sector-stat-value price-down">${data.down}</div>
                            <div class="sector-stat-label">ä¸‹è·Œ</div>
                        </div>
                        <div class="sector-stat">
                            <div class="sector-stat-value price-flat">${data.flat}</div>
                            <div class="sector-stat-label">å¹³ç›˜</div>
                        </div>
                    </div>
                    <div class="sector-top-list">
                        <div style="color: var(--accent-green); margin-bottom: 0.25rem;">é¢†æ¶¨æ¿å—</div>
                        ${topItems}
                        <div style="color: var(--accent-red); margin-top: 0.5rem; margin-bottom: 0.25rem;">é¢†è·Œæ¿å—</div>
                        ${bottomItems}
                    </div>
                </div>
            `;
        }

        async function loadIndustrySectors() {
            const direction = document.getElementById('industrySort').value;
            const container = document.getElementById('industrySectorList');

            try {
                const result = await apiCall(`/api/market/sectors/top?type=industry&direction=${direction}&count=15`);
                if (result.success && result.data) {
                    renderSectorList(container, result.data.sectors, 'industry');
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>åŠ è½½å¤±è´¥</p></div>';
            }
        }

        async function loadConceptSectors() {
            const direction = document.getElementById('conceptSort').value;
            const container = document.getElementById('conceptSectorList');

            try {
                const result = await apiCall(`/api/market/sectors/top?type=concept&direction=${direction}&count=15`);
                if (result.success && result.data) {
                    renderSectorList(container, result.data.sectors, 'concept');
                }
            } catch (error) {
                container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>åŠ è½½å¤±è´¥</p></div>';
            }
        }

        async function loadSectorFlow() {
            const type = document.getElementById('flowType').value;
            const inContainer = document.getElementById('sectorFlowInList');
            const outContainer = document.getElementById('sectorFlowOutList');

            try {
                const result = await apiCall(`/api/market/sectors/flow?type=${type}&count=30`);
                if (result.success && result.data) {
                    renderFlowList(inContainer, result.data.top_inflow, true);
                    renderFlowList(outContainer, result.data.top_outflow, false);
                }
            } catch (error) {
                inContainer.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>åŠ è½½å¤±è´¥</p></div>';
                outContainer.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>åŠ è½½å¤±è´¥</p></div>';
            }
        }

        function renderSectorList(container, sectors, type) {
            if (!sectors || sectors.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>æš‚æ— æ•°æ®</p></div>';
                return;
            }

            let html = '';
            sectors.forEach((s, i) => {
                const changeColor = (s.change_percent || 0) >= 0 ? 'price-up' : 'price-down';
                const changeSign = (s.change_percent || 0) >= 0 ? '+' : '';
                html += `
                    <div class="sector-item" onclick="showSectorDetail('${s.code}', '${s.name}')">
                        <div class="sector-rank">${i + 1}</div>
                        <div class="sector-info">
                            <div class="sector-name">${s.name}</div>
                            <div class="sector-stats">æ¶¨:${s.up_count || 0} è·Œ:${s.down_count || 0}</div>
                        </div>
                        <div class="sector-change ${changeColor}">${changeSign}${(s.change_percent || 0).toFixed(2)}%</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderFlowList(container, sectors, isInflow) {
            if (!sectors || sectors.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>æš‚æ— æ•°æ®</p></div>';
                return;
            }

            let html = '';
            sectors.forEach((s, i) => {
                const flow = (s.main_net_inflow || 0) / 100000000;
                const flowColor = flow >= 0 ? 'price-up' : 'price-down';
                const flowSign = flow >= 0 ? '+' : '';
                const changeColor = (s.change_percent || 0) >= 0 ? 'price-up' : 'price-down';
                html += `
                    <div class="sector-item" onclick="showSectorDetail('${s.code}', '${s.name}')">
                        <div class="sector-rank">${i + 1}</div>
                        <div class="sector-info">
                            <div class="sector-name">${s.name}</div>
                            <div class="sector-stats ${changeColor}">${(s.change_percent || 0).toFixed(2)}%</div>
                        </div>
                        <div class="sector-flow ${flowColor}">${flowSign}${flow.toFixed(2)}äº¿</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        async function showSectorDetail(code, name) {
            const card = document.getElementById('sectorDetailCard');
            const title = document.getElementById('sectorDetailTitle');
            const content = document.getElementById('sectorDetailContent');

            card.style.display = 'block';
            title.textContent = `${name} æˆåˆ†è‚¡`;
            content.innerHTML = '<div class="ai-loading"><div class="spinner"></div><span>åŠ è½½ä¸­...</span></div>';

            try {
                const result = await apiCall(`/api/market/sectors/${code}/stocks?count=30`);
                if (result.success && result.data && result.data.stocks) {
                    let html = '<table class="stock-table"><thead><tr><th>ä»£ç </th><th>åç§°</th><th>ç°ä»·</th><th>æ¶¨è·Œå¹…</th><th>æˆäº¤é¢</th></tr></thead><tbody>';
                    result.data.stocks.forEach(s => {
                        const changeColor = (s.change_percent || 0) >= 0 ? 'price-up' : 'price-down';
                        const changeSign = (s.change_percent || 0) >= 0 ? '+' : '';
                        const turnover = ((s.turnover || 0) / 100000000).toFixed(2);
                        html += `
                            <tr onclick="showStockDetail('${s.code}')">
                                <td class="stock-code">${s.code}</td>
                                <td class="stock-name">${s.name}</td>
                                <td>${(s.price || 0).toFixed(2)}</td>
                                <td class="${changeColor}">${changeSign}${(s.change_percent || 0).toFixed(2)}%</td>
                                <td>${turnover}äº¿</td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    content.innerHTML = html;
                } else {
                    content.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>æš‚æ— æˆåˆ†è‚¡æ•°æ®</p></div>';
                }
            } catch (error) {
                content.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>åŠ è½½å¤±è´¥</p></div>';
            }
        }

        function closeSectorDetail() {
            document.getElementById('sectorDetailCard').style.display = 'none';
        }

        // ============ æŠ€æœ¯æŒ‡æ ‡åˆ†æ ============
        let klineChart = null;
        let macdChart = null;
        let kdjChart = null;
        let rsiChart = null;
        let bollChart = null;

        function fillTechnicalFromWatchlist() {
            if (watchList.length === 0) {
                alert('å…³æ³¨åˆ—è¡¨ä¸ºç©º');
                return;
            }
            const code = watchList[0].code;
            document.getElementById('technicalStockInput').value = code;
        }

        async function loadTechnicalAnalysis() {
            const code = document.getElementById('technicalStockInput').value.trim();
            const days = document.getElementById('technicalDays').value;

            if (!code) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('technicalEmpty').style.display = 'none';
            document.getElementById('technicalSignals').style.display = 'block';
            document.getElementById('signalsList').innerHTML = '<div class="ai-loading"><div class="spinner"></div><span>åˆ†æä¸­...</span></div>';

            try {
                const result = await apiCall(`/api/analysis/technical/${code}?days=${days}`);

                if (!result.success) {
                    throw new Error(result.detail || 'è·å–æŠ€æœ¯æŒ‡æ ‡å¤±è´¥');
                }

                const data = result.data;

                // æ›´æ–°ä¿¡å·æ‘˜è¦
                updateTechnicalSignals(data);

                // æ›´æ–°æŒ‡æ ‡æ•°å€¼
                updateIndicatorValues(data);

                // ç»˜åˆ¶å›¾è¡¨
                drawTechnicalCharts(data);

                // æ˜¾ç¤ºå›¾è¡¨åŒºåŸŸ
                document.getElementById('technicalCharts').style.display = 'block';
                document.getElementById('technicalValues').style.display = 'block';

            } catch (error) {
                document.getElementById('signalsList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âŒ</div>
                        <p>${error.message}</p>
                    </div>
                `;
                document.getElementById('technicalCharts').style.display = 'none';
                document.getElementById('technicalValues').style.display = 'none';
            }
        }

        function updateTechnicalSignals(data) {
            const signals = data.latest_signals;
            const overallEl = document.getElementById('overallSignal');
            overallEl.textContent = signals.overall;
            overallEl.style.color = signals.overall_color;
            overallEl.style.fontWeight = 'bold';
            overallEl.style.fontSize = '1.2rem';

            let signalsHtml = '<div class="signals-grid">';
            if (signals.signals && signals.signals.length > 0) {
                signals.signals.forEach(s => {
                    const typeClass = s.type === 'buy' ? 'signal-buy' :
                                     s.type === 'sell' ? 'signal-sell' : 'signal-warning';
                    const typeIcon = s.type === 'buy' ? 'ğŸ“ˆ' :
                                    s.type === 'sell' ? 'ğŸ“‰' : 'âš ï¸';
                    signalsHtml += `
                        <div class="signal-item ${typeClass}">
                            <span class="signal-icon">${typeIcon}</span>
                            <span class="signal-indicator">${s.indicator}</span>
                            <span class="signal-text">${s.signal}</span>
                        </div>
                    `;
                });
            } else {
                signalsHtml += '<div class="empty-state" style="padding: 1rem;"><p>æš‚æ— æ˜æ˜¾ä¿¡å·</p></div>';
            }
            signalsHtml += '</div>';

            signalsHtml += `
                <div class="signal-summary" style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                    <span style="color: var(--accent-green);">çœ‹å¤šä¿¡å·: ${signals.bullish_count}</span>
                    <span style="margin-left: 1.5rem; color: var(--accent-red);">çœ‹ç©ºä¿¡å·: ${signals.bearish_count}</span>
                </div>
            `;

            document.getElementById('signalsList').innerHTML = signalsHtml;
        }

        function updateIndicatorValues(data) {
            const values = data.latest_signals.latest_values;
            const html = `
                <div class="indicator-value-card">
                    <div class="indicator-label">MACD DIF</div>
                    <div class="indicator-num ${values.macd_dif >= 0 ? 'green' : 'red'}">${values.macd_dif?.toFixed(3) || '--'}</div>
                </div>
                <div class="indicator-value-card">
                    <div class="indicator-label">MACD DEA</div>
                    <div class="indicator-num ${values.macd_dea >= 0 ? 'green' : 'red'}">${values.macd_dea?.toFixed(3) || '--'}</div>
                </div>
                <div class="indicator-value-card">
                    <div class="indicator-label">KDJ K</div>
                    <div class="indicator-num">${values.kdj_k?.toFixed(2) || '--'}</div>
                </div>
                <div class="indicator-value-card">
                    <div class="indicator-label">KDJ D</div>
                    <div class="indicator-num">${values.kdj_d?.toFixed(2) || '--'}</div>
                </div>
                <div class="indicator-value-card">
                    <div class="indicator-label">KDJ J</div>
                    <div class="indicator-num ${values.kdj_j > 100 ? 'red' : values.kdj_j < 0 ? 'green' : ''}">${values.kdj_j?.toFixed(2) || '--'}</div>
                </div>
                <div class="indicator-value-card">
                    <div class="indicator-label">RSI</div>
                    <div class="indicator-num ${values.rsi >= 70 ? 'red' : values.rsi <= 30 ? 'green' : ''}">${values.rsi?.toFixed(2) || '--'}</div>
                </div>
                <div class="indicator-value-card">
                    <div class="indicator-label">BOLL ä¸Šè½¨</div>
                    <div class="indicator-num">${values.boll_upper?.toFixed(2) || '--'}</div>
                </div>
                <div class="indicator-value-card">
                    <div class="indicator-label">BOLL ä¸‹è½¨</div>
                    <div class="indicator-num">${values.boll_lower?.toFixed(2) || '--'}</div>
                </div>
            `;
            document.getElementById('indicatorValues').innerHTML = html;
        }

        function drawTechnicalCharts(data) {
            const dates = data.dates;
            const prices = data.prices;
            const indicators = data.indicators;

            // Kçº¿å›¾
            drawKlineChart(dates, prices, indicators.ma, indicators.boll);

            // MACDå›¾
            drawMacdChart(dates, indicators.macd);

            // KDJå›¾
            drawKdjChart(dates, indicators.kdj);

            // RSIå›¾
            drawRsiChart(dates, indicators.rsi);

            // å¸ƒæ—å¸¦å›¾
            drawBollChart(dates, prices.close, indicators.boll);
        }

        function drawKlineChart(dates, prices, ma, boll) {
            if (!klineChart) {
                klineChart = echarts.init(document.getElementById('klineChart'));
            }
            klineChart.clear();

            // å‡†å¤‡Kçº¿æ•°æ®
            const klineData = dates.map((d, i) => [
                prices.open[i], prices.close[i], prices.low[i], prices.high[i]
            ]);

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: {
                    data: ['Kçº¿', 'MA5', 'MA10', 'MA20', 'MA60'],
                    textStyle: { color: '#a0a0a0' },
                    top: 0
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: { lineStyle: { color: '#2d2d5a' } },
                    axisLabel: { color: '#a0a0a0' }
                },
                yAxis: {
                    type: 'value',
                    scale: true,
                    axisLine: { lineStyle: { color: '#2d2d5a' } },
                    axisLabel: { color: '#a0a0a0' },
                    splitLine: { lineStyle: { color: '#2d2d5a', type: 'dashed' } }
                },
                dataZoom: [
                    { type: 'inside', start: 50, end: 100 },
                    { show: true, type: 'slider', bottom: '5%', start: 50, end: 100 }
                ],
                series: [
                    {
                        name: 'Kçº¿',
                        type: 'candlestick',
                        data: klineData,
                        itemStyle: {
                            color: '#ef4444',
                            color0: '#10b981',
                            borderColor: '#ef4444',
                            borderColor0: '#10b981'
                        }
                    },
                    {
                        name: 'MA5',
                        type: 'line',
                        data: ma.ma5,
                        smooth: true,
                        lineStyle: { width: 1, color: '#f59e0b' },
                        symbol: 'none'
                    },
                    {
                        name: 'MA10',
                        type: 'line',
                        data: ma.ma10,
                        smooth: true,
                        lineStyle: { width: 1, color: '#3b82f6' },
                        symbol: 'none'
                    },
                    {
                        name: 'MA20',
                        type: 'line',
                        data: ma.ma20,
                        smooth: true,
                        lineStyle: { width: 1, color: '#a855f7' },
                        symbol: 'none'
                    },
                    {
                        name: 'MA60',
                        type: 'line',
                        data: ma.ma60,
                        smooth: true,
                        lineStyle: { width: 1, color: '#22d3ee' },
                        symbol: 'none'
                    }
                ]
            };
            klineChart.setOption(option);
        }

        function drawMacdChart(dates, macd) {
            if (!macdChart) {
                macdChart = echarts.init(document.getElementById('macdChart'));
            }
            macdChart.clear();

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: {
                    data: ['DIF', 'DEA', 'MACD'],
                    textStyle: { color: '#a0a0a0' },
                    top: 0
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: { lineStyle: { color: '#2d2d5a' } },
                    axisLabel: { color: '#a0a0a0', show: false }
                },
                yAxis: {
                    type: 'value',
                    scale: true,
                    axisLine: { lineStyle: { color: '#2d2d5a' } },
                    axisLabel: { color: '#a0a0a0' },
                    splitLine: { lineStyle: { color: '#2d2d5a', type: 'dashed' } }
                },
                dataZoom: [
                    { type: 'inside', start: 50, end: 100 }
                ],
                series: [
                    {
                        name: 'DIF',
                        type: 'line',
                        data: macd.dif,
                        lineStyle: { width: 1, color: '#f59e0b' },
                        symbol: 'none'
                    },
                    {
                        name: 'DEA',
                        type: 'line',
                        data: macd.dea,
                        lineStyle: { width: 1, color: '#3b82f6' },
                        symbol: 'none'
                    },
                    {
                        name: 'MACD',
                        type: 'bar',
                        data: macd.macd.map(v => ({
                            value: v,
                            itemStyle: { color: v >= 0 ? '#ef4444' : '#10b981' }
                        }))
                    }
                ]
            };
            macdChart.setOption(option);
        }

        function drawKdjChart(dates, kdj) {
            if (!kdjChart) {
                kdjChart = echarts.init(document.getElementById('kdjChart'));
            }
            kdjChart.clear();

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: {
                    data: ['K', 'D', 'J'],
                    textStyle: { color: '#a0a0a0' },
                    top: 0
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: { lineStyle: { color: '#2d2d5a' } },
                    axisLabel: { color: '#a0a0a0', show: false }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    axisLine: { lineStyle: { color: '#2d2d5a' } },
                    axisLabel: { color: '#a0a0a0' },
                    splitLine: { lineStyle: { color: '#2d2d5a', type: 'dashed' } }
                },
                dataZoom: [
                    { type: 'inside', start: 50, end: 100 }
                ],
                series: [
                    {
                        name: 'K',
                        type: 'line',
                        data: kdj.k,
                        lineStyle: { width: 1, color: '#f59e0b' },
                        symbol: 'none'
                    },
                    {
                        name: 'D',
                        type: 'line',
                        data: kdj.d,
                        lineStyle: { width: 1, color: '#3b82f6' },
                        symbol: 'none'
                    },
                    {
                        name: 'J',
                        type: 'line',
                        data: kdj.j,
                        lineStyle: { width: 1, color: '#a855f7' },
                        symbol: 'none'
                    }
                ],
                // è¶…ä¹°è¶…å–åŒºåŸŸ
                markLine: {
                    silent: true,
                    data: [
                        { yAxis: 80, lineStyle: { color: '#ef4444', type: 'dashed' } },
                        { yAxis: 20, lineStyle: { color: '#10b981', type: 'dashed' } }
                    ]
                }
            };
            kdjChart.setOption(option);
        }

        function drawRsiChart(dates, rsi) {
            if (!rsiChart) {
                rsiChart = echarts.init(document.getElementById('rsiChart'));
            }
            rsiChart.clear();

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: {
                    data: ['RSI'],
                    textStyle: { color: '#a0a0a0' },
                    top: 0
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: { lineStyle: { color: '#2d2d5a' } },
                    axisLabel: { color: '#a0a0a0', show: false }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    axisLine: { lineStyle: { color: '#2d2d5a' } },
                    axisLabel: { color: '#a0a0a0' },
                    splitLine: { lineStyle: { color: '#2d2d5a', type: 'dashed' } }
                },
                dataZoom: [
                    { type: 'inside', start: 50, end: 100 }
                ],
                visualMap: {
                    show: false,
                    pieces: [
                        { lte: 30, color: '#10b981' },
                        { gt: 30, lte: 70, color: '#3b82f6' },
                        { gt: 70, color: '#ef4444' }
                    ]
                },
                series: [
                    {
                        name: 'RSI',
                        type: 'line',
                        data: rsi.rsi,
                        lineStyle: { width: 2 },
                        symbol: 'none',
                        areaStyle: { opacity: 0.1 },
                        markLine: {
                            silent: true,
                            data: [
                                { yAxis: 70, lineStyle: { color: '#ef4444', type: 'dashed' } },
                                { yAxis: 30, lineStyle: { color: '#10b981', type: 'dashed' } }
                            ]
                        }
                    }
                ]
            };
            rsiChart.setOption(option);
        }

        function drawBollChart(dates, closes, boll) {
            if (!bollChart) {
                bollChart = echarts.init(document.getElementById('bollChart'));
            }
            bollChart.clear();

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                legend: {
                    data: ['ä»·æ ¼', 'ä¸Šè½¨', 'ä¸­è½¨', 'ä¸‹è½¨'],
                    textStyle: { color: '#a0a0a0' },
                    top: 0
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLine: { lineStyle: { color: '#2d2d5a' } },
                    axisLabel: { color: '#a0a0a0', show: false }
                },
                yAxis: {
                    type: 'value',
                    scale: true,
                    axisLine: { lineStyle: { color: '#2d2d5a' } },
                    axisLabel: { color: '#a0a0a0' },
                    splitLine: { lineStyle: { color: '#2d2d5a', type: 'dashed' } }
                },
                dataZoom: [
                    { type: 'inside', start: 50, end: 100 }
                ],
                series: [
                    {
                        name: 'ä»·æ ¼',
                        type: 'line',
                        data: closes,
                        lineStyle: { width: 2, color: '#f59e0b' },
                        symbol: 'none'
                    },
                    {
                        name: 'ä¸Šè½¨',
                        type: 'line',
                        data: boll.upper,
                        lineStyle: { width: 1, color: '#ef4444', type: 'dashed' },
                        symbol: 'none'
                    },
                    {
                        name: 'ä¸­è½¨',
                        type: 'line',
                        data: boll.middle,
                        lineStyle: { width: 1, color: '#3b82f6' },
                        symbol: 'none'
                    },
                    {
                        name: 'ä¸‹è½¨',
                        type: 'line',
                        data: boll.lower,
                        lineStyle: { width: 1, color: '#10b981', type: 'dashed' },
                        symbol: 'none'
                    }
                ]
            };
            bollChart.setOption(option);
        }

        // Window resize handler for charts
        window.addEventListener('resize', function() {
            if (sentimentChart) sentimentChart.resize();
            if (northFlowChart) northFlowChart.resize();
            if (klineChart) klineChart.resize();
            if (macdChart) macdChart.resize();
            if (kdjChart) kdjChart.resize();
            if (rsiChart) rsiChart.resize();
            if (bollChart) bollChart.resize();
            if (roeTrendChart) roeTrendChart.resize();
            if (marginTrendChart) marginTrendChart.resize();
            if (usKlineChart) usKlineChart.resize();
        });

        // ============ è´¢æŠ¥åˆ†ææ¨¡å— ============
        let roeTrendChart = null;
        let marginTrendChart = null;

        function fillFinanceFromWatchlist() {
            const selector = document.getElementById('financeWatchlistSelector');
            const itemsContainer = document.getElementById('financeWatchlistItems');

            if (selector.style.display === 'none') {
                // æ˜¾ç¤ºé€‰æ‹©å™¨å¹¶åŠ è½½å…³æ³¨åˆ—è¡¨
                selector.style.display = 'block';
                loadFinanceWatchlistItems();
            } else {
                selector.style.display = 'none';
            }
        }

        async function loadFinanceWatchlistItems() {
            const result = await apiCall('/api/stocks/watch-list');
            const container = document.getElementById('financeWatchlistItems');

            if (result.success && result.data && result.data.length > 0) {
                container.innerHTML = result.data.map(item => `
                    <button class="btn btn-sm" style="background: var(--bg-secondary);"
                            onclick="selectFinanceStock('${item.code}', '${item.name}')">
                        ${item.name} (${item.code})
                    </button>
                `).join('');
            } else {
                container.innerHTML = '<span style="color: var(--text-secondary);">å…³æ³¨åˆ—è¡¨ä¸ºç©º</span>';
            }
        }

        function selectFinanceStock(code, name) {
            document.getElementById('financeCodeInput').value = code;
            document.getElementById('financeWatchlistSelector').style.display = 'none';
            loadFinanceAnalysis();
        }

        async function loadFinanceAnalysis() {
            const code = document.getElementById('financeCodeInput').value.trim();
            if (!code) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('financeLoading').style.display = 'block';
            document.getElementById('financeResult').style.display = 'none';

            try {
                const result = await apiCall(`/api/analysis/finance/${code}`);

                if (result.success && result.data) {
                    renderFinanceAnalysis(result.data);
                    document.getElementById('financeResult').style.display = 'block';
                } else {
                    alert(result.message || 'è·å–è´¢åŠ¡æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                alert('è·å–è´¢åŠ¡æ•°æ®å¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('financeLoading').style.display = 'none';
            }
        }

        function renderFinanceAnalysis(data) {
            // è‚¡ç¥¨ä¿¡æ¯
            document.getElementById('financeStockName').textContent = data.name || '--';
            document.getElementById('financeStockCode').textContent = data.code || '';
            document.getElementById('financeStockPrice').textContent = data.price ? data.price.toFixed(2) : '--';

            const changePercent = data.change_percent || 0;
            const changeEl = document.getElementById('financeStockChange');
            changeEl.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
            changeEl.className = changePercent >= 0 ? 'text-green' : 'text-red';

            // å¥åº·åº¦è¯„åˆ†
            renderHealthScore(data.health_score);

            // è´¢åŠ¡æŒ‡æ ‡è¡¨æ ¼
            renderFinanceIndicators(data.finance_data?.indicators || []);

            // è´¢åŠ¡æ¯”ç‡
            renderFinanceRatios(data.ratios || {});

            // è¡Œä¸šå¯¹æ¯”
            renderIndustryComparison(data.industry_comparison);

            // è¶‹åŠ¿å›¾è¡¨
            renderFinanceTrends(data.trends || {});
        }

        function renderHealthScore(health) {
            if (!health) return;

            const totalScoreEl = document.getElementById('healthTotalScore');
            const totalLevelEl = document.getElementById('healthTotalLevel');
            const interpretationEl = document.getElementById('healthInterpretation');
            const detailsEl = document.getElementById('healthDetailScores');

            // æ€»åˆ†
            totalScoreEl.textContent = health.total_score || '--';
            totalScoreEl.style.color = health.total_level?.color || 'inherit';
            totalLevelEl.textContent = `${health.total_level?.icon || ''} ${health.total_level?.level || ''}`;
            totalLevelEl.style.color = health.total_level?.color || 'inherit';

            // è§£è¯»
            interpretationEl.innerHTML = (health.interpretation || []).map(t => `<p>â€¢ ${t}</p>`).join('');

            // å››ä¸ªç»´åº¦
            const dimensions = [
                { key: 'profitability', name: 'ç›ˆåˆ©èƒ½åŠ›', icon: 'ğŸ’°' },
                { key: 'solvency', name: 'å¿å€ºèƒ½åŠ›', icon: 'ğŸ¦' },
                { key: 'operation', name: 'è¿è¥èƒ½åŠ›', icon: 'âš™ï¸' },
                { key: 'growth', name: 'æˆé•¿èƒ½åŠ›', icon: 'ğŸ“ˆ' }
            ];

            detailsEl.innerHTML = dimensions.map(dim => {
                const score = health.details?.[dim.key] || {};
                return `
                    <div class="stat-card" style="background: var(--bg-secondary);">
                        <div class="stat-label">${dim.icon} ${dim.name}</div>
                        <div class="stat-value" style="color: ${score.level?.color || 'inherit'};">
                            ${(score.score || 0).toFixed(1)}
                        </div>
                        <div style="font-size: 0.75rem; color: ${score.level?.color || 'var(--text-secondary)'};">
                            ${score.level?.icon || ''} ${score.level?.level || ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderFinanceIndicators(indicators) {
            const tbody = document.getElementById('financeIndicatorsBody');

            if (!indicators || indicators.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = indicators.map(ind => `
                <tr>
                    <td>${ind.report_date || '--'} ${ind.report_type || ''}</td>
                    <td>${formatNumber(ind.eps)}</td>
                    <td>${formatPercent(ind.roe)}</td>
                    <td>${formatPercent(ind.gross_margin)}</td>
                    <td>${formatPercent(ind.net_margin)}</td>
                    <td>${formatPercent(ind.debt_ratio)}</td>
                </tr>
            `).join('');
        }

        function renderFinanceRatios(ratios) {
            // ç›ˆåˆ©èƒ½åŠ›
            const profitability = ratios.profitability || {};
            document.getElementById('profitabilityRatios').innerHTML = `
                <div class="ratio-item"><span>å‡€èµ„äº§æ”¶ç›Šç‡(ROE)</span><span class="ratio-value">${formatPercent(profitability.roe)}</span></div>
                <div class="ratio-item"><span>æ¯›åˆ©ç‡</span><span class="ratio-value">${formatPercent(profitability.gross_margin)}</span></div>
                <div class="ratio-item"><span>å‡€åˆ©ç‡</span><span class="ratio-value">${formatPercent(profitability.net_margin)}</span></div>
                <div class="ratio-item"><span>æ¯è‚¡æ”¶ç›Š(EPS)</span><span class="ratio-value">${formatNumber(profitability.eps)}</span></div>
            `;

            // å¿å€ºèƒ½åŠ›
            const solvency = ratios.solvency || {};
            document.getElementById('solvencyRatios').innerHTML = `
                <div class="ratio-item"><span>èµ„äº§è´Ÿå€ºç‡</span><span class="ratio-value">${formatPercent(solvency.debt_ratio)}</span></div>
                <div class="ratio-item"><span>æµåŠ¨æ¯”ç‡</span><span class="ratio-value">${formatNumber(solvency.current_ratio)}</span></div>
                <div class="ratio-item"><span>é€ŸåŠ¨æ¯”ç‡</span><span class="ratio-value">${formatNumber(solvency.quick_ratio)}</span></div>
                <div class="ratio-item"><span>äº§æƒæ¯”ç‡</span><span class="ratio-value">${formatNumber(solvency.debt_to_equity)}</span></div>
            `;

            // è¿è¥èƒ½åŠ›
            const operation = ratios.operation || {};
            document.getElementById('operationRatios').innerHTML = `
                <div class="ratio-item"><span>åº”æ”¶è´¦æ¬¾å‘¨è½¬ç‡</span><span class="ratio-value">${formatNumber(operation.receivable_turnover)}</span></div>
                <div class="ratio-item"><span>å­˜è´§å‘¨è½¬ç‡</span><span class="ratio-value">${formatNumber(operation.inventory_turnover)}</span></div>
                <div class="ratio-item"><span>æ€»èµ„äº§å‘¨è½¬ç‡</span><span class="ratio-value">${formatNumber(operation.asset_turnover)}</span></div>
            `;

            // æˆé•¿èƒ½åŠ›
            const growth = ratios.growth || {};
            document.getElementById('growthRatios').innerHTML = `
                <div class="ratio-item"><span>è¥æ”¶åŒæ¯”å¢é•¿</span><span class="ratio-value ${growth.revenue_yoy >= 0 ? 'text-green' : 'text-red'}">${formatPercent(growth.revenue_yoy)}</span></div>
                <div class="ratio-item"><span>å‡€åˆ©æ¶¦åŒæ¯”å¢é•¿</span><span class="ratio-value ${growth.profit_yoy >= 0 ? 'text-green' : 'text-red'}">${formatPercent(growth.profit_yoy)}</span></div>
                ${growth.roe_change !== undefined ? `<div class="ratio-item"><span>ROEç¯æ¯”å˜åŒ–</span><span class="ratio-value ${growth.roe_change >= 0 ? 'text-green' : 'text-red'}">${formatPercent(growth.roe_change)}</span></div>` : ''}
            `;
        }

        function renderIndustryComparison(comparison) {
            if (!comparison) {
                document.getElementById('industryComparison').innerHTML = '<div style="color: var(--text-secondary);">æš‚æ— è¡Œä¸šå¯¹æ¯”æ•°æ®</div>';
                return;
            }

            // è¡Œä¸šåç§°
            document.getElementById('financeIndustryName').textContent = comparison.industry_name || '';

            // è¡Œä¸šæ’å
            document.getElementById('industryRank').textContent =
                comparison.rank ? `ç¬¬ ${comparison.rank} å / å…± ${comparison.total_count} å®¶` : '--';

            // è¡Œä¸šå¹³å‡æŒ‡æ ‡
            const avg = comparison.industry_avg || {};
            document.getElementById('industryAvgMetrics').innerHTML = `
                <div class="stat-card" style="background: var(--bg-secondary);">
                    <div class="stat-label">è¡Œä¸šå¹³å‡PE</div>
                    <div class="stat-value" style="font-size: 1.2rem;">${formatNumber(avg.pe_ttm)}</div>
                </div>
                <div class="stat-card" style="background: var(--bg-secondary);">
                    <div class="stat-label">è¡Œä¸šå¹³å‡PB</div>
                    <div class="stat-value" style="font-size: 1.2rem;">${formatNumber(avg.pb)}</div>
                </div>
                <div class="stat-card" style="background: var(--bg-secondary);">
                    <div class="stat-label">è¡Œä¸šå¹³å‡ROE</div>
                    <div class="stat-value" style="font-size: 1.2rem;">${formatPercent(avg.roe)}</div>
                </div>
                <div class="stat-card" style="background: var(--bg-secondary);">
                    <div class="stat-label">è¡Œä¸šå¹³å‡æ¯›åˆ©ç‡</div>
                    <div class="stat-value" style="font-size: 1.2rem;">${formatPercent(avg.gross_margin)}</div>
                </div>
                <div class="stat-card" style="background: var(--bg-secondary);">
                    <div class="stat-label">è¡Œä¸šå¹³å‡å‡€åˆ©ç‡</div>
                    <div class="stat-value" style="font-size: 1.2rem;">${formatPercent(avg.net_margin)}</div>
                </div>
            `;

            // åŒè¡Œä¸šå…¬å¸åˆ—è¡¨
            const companies = comparison.companies || [];
            document.getElementById('industryPeers').innerHTML = companies.length > 0 ? `
                <table class="data-table" style="width: 100%; font-size: 0.85rem;">
                    <thead>
                        <tr>
                            <th>ä»£ç </th>
                            <th>åç§°</th>
                            <th>å¸‚å€¼(äº¿)</th>
                            <th>PE(TTM)</th>
                            <th>PB</th>
                            <th>ROE</th>
                            <th>æ¯›åˆ©ç‡</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${companies.slice(0, 15).map(c => `
                            <tr style="${c.code === comparison.code ? 'background: rgba(79, 172, 254, 0.1);' : ''}">
                                <td>${c.code}</td>
                                <td>${c.name}</td>
                                <td>${formatBigNumber(c.market_cap)}</td>
                                <td>${formatNumber(c.pe_ttm)}</td>
                                <td>${formatNumber(c.pb)}</td>
                                <td>${formatPercent(c.roe)}</td>
                                <td>${formatPercent(c.gross_margin)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<div style="color: var(--text-secondary);">æš‚æ— æ•°æ®</div>';
        }

        function renderFinanceTrends(trends) {
            // ROEè¶‹åŠ¿å›¾
            const roeData = (trends.roe_trend || []).reverse();
            if (roeData.length > 0) {
                if (!roeTrendChart) {
                    roeTrendChart = echarts.init(document.getElementById('roeTrendChart'));
                }
                roeTrendChart.clear();
                roeTrendChart.setOption({
                    backgroundColor: 'transparent',
                    tooltip: { trigger: 'axis' },
                    grid: { left: 50, right: 20, top: 20, bottom: 30 },
                    xAxis: {
                        type: 'category',
                        data: roeData.map(d => d.date),
                        axisLabel: { color: '#a0a0a0', fontSize: 10 },
                        axisLine: { lineStyle: { color: '#2d2d5a' } }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: { color: '#a0a0a0', formatter: '{value}%' },
                        axisLine: { lineStyle: { color: '#2d2d5a' } },
                        splitLine: { lineStyle: { color: '#2d2d5a' } }
                    },
                    series: [{
                        type: 'line',
                        data: roeData.map(d => d.value),
                        smooth: true,
                        lineStyle: { color: '#4facfe', width: 2 },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(79, 172, 254, 0.3)' },
                                { offset: 1, color: 'rgba(79, 172, 254, 0)' }
                            ])
                        },
                        itemStyle: { color: '#4facfe' }
                    }]
                });
            }

            // åˆ©æ¶¦ç‡è¶‹åŠ¿å›¾
            const marginData = (trends.margin_trend || []).reverse();
            if (marginData.length > 0) {
                if (!marginTrendChart) {
                    marginTrendChart = echarts.init(document.getElementById('marginTrendChart'));
                }
                marginTrendChart.clear();
                marginTrendChart.setOption({
                    backgroundColor: 'transparent',
                    tooltip: { trigger: 'axis' },
                    legend: {
                        data: ['æ¯›åˆ©ç‡', 'å‡€åˆ©ç‡'],
                        textStyle: { color: '#a0a0a0' },
                        top: 0
                    },
                    grid: { left: 50, right: 20, top: 30, bottom: 30 },
                    xAxis: {
                        type: 'category',
                        data: marginData.map(d => d.date),
                        axisLabel: { color: '#a0a0a0', fontSize: 10 },
                        axisLine: { lineStyle: { color: '#2d2d5a' } }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: { color: '#a0a0a0', formatter: '{value}%' },
                        axisLine: { lineStyle: { color: '#2d2d5a' } },
                        splitLine: { lineStyle: { color: '#2d2d5a' } }
                    },
                    series: [
                        {
                            name: 'æ¯›åˆ©ç‡',
                            type: 'line',
                            data: marginData.map(d => d.gross_margin),
                            smooth: true,
                            lineStyle: { color: '#10b981', width: 2 },
                            itemStyle: { color: '#10b981' }
                        },
                        {
                            name: 'å‡€åˆ©ç‡',
                            type: 'line',
                            data: marginData.map(d => d.net_margin),
                            smooth: true,
                            lineStyle: { color: '#f59e0b', width: 2 },
                            itemStyle: { color: '#f59e0b' }
                        }
                    ]
                });
            }
        }

        function formatNumber(val) {
            if (val === null || val === undefined || isNaN(val)) return '--';
            return Number(val).toFixed(2);
        }

        function formatPercent(val) {
            if (val === null || val === undefined || isNaN(val)) return '--';
            return Number(val).toFixed(2) + '%';
        }

        function formatBigNumber(val) {
            if (val === null || val === undefined || isNaN(val)) return '--';
            const num = Number(val);
            if (num >= 100000000) {
                return (num / 100000000).toFixed(2);
            } else if (num >= 10000) {
                return (num / 10000).toFixed(2) + 'ä¸‡';
            }
            return num.toFixed(2);
        }

        // ============ æ•°æ®å¯¼å‡ºåŠŸèƒ½ ============
        function exportWatchlist() {
            window.open('/api/export/watchlist', '_blank');
        }

        function exportFinanceData() {
            const code = document.getElementById('financeCodeInput').value.trim();
            if (!code) {
                alert('è¯·å…ˆè¾“å…¥è‚¡ç¥¨ä»£ç å¹¶åˆ†æ');
                return;
            }
            window.open(`/api/export/stock/${code}/finance`, '_blank');
        }

        function exportKlineData(code, days = 60) {
            if (!code) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }
            window.open(`/api/export/stock/${code}/kline?days=${days}`, '_blank');
        }

        function exportPortfolio() {
            window.open('/api/export/portfolio', '_blank');
        }

        function exportSectors(type = 'industry') {
            window.open(`/api/export/sectors/${type}`, '_blank');
        }

        // ============ é€‰è‚¡å™¨æ¨¡å— ============
        let currentScreenPage = 1;
        let currentScreenParams = {};

        async function quickScreen(type) {
            document.getElementById('screenResultLoading').style.display = 'block';
            document.getElementById('screenResultTable').innerHTML = '';
            document.getElementById('screenPagination').style.display = 'none';

            try {
                const result = await apiCall(`/api/screener/quick/${type}`);

                if (result.success) {
                    document.getElementById('screenPresetName').textContent = result.preset_name || '';
                    renderScreenResult(result);
                } else {
                    document.getElementById('screenResultTable').innerHTML =
                        `<div style="text-align: center; color: var(--accent-red); padding: 2rem;">${result.error || 'ç­›é€‰å¤±è´¥'}</div>`;
                }
            } catch (error) {
                document.getElementById('screenResultTable').innerHTML =
                    `<div style="text-align: center; color: var(--accent-red); padding: 2rem;">ç­›é€‰å¤±è´¥: ${error.message}</div>`;
            } finally {
                document.getElementById('screenResultLoading').style.display = 'none';
            }
        }

        async function customScreen(page = 1) {
            const params = {
                market_cap_min: document.getElementById('screenMarketCapMin').value || undefined,
                market_cap_max: document.getElementById('screenMarketCapMax').value || undefined,
                pe_min: document.getElementById('screenPeMin').value || undefined,
                pe_max: document.getElementById('screenPeMax').value || undefined,
                change_min: document.getElementById('screenChangeMin').value || undefined,
                change_max: document.getElementById('screenChangeMax').value || undefined,
                turnover_min: document.getElementById('screenTurnoverMin').value || undefined,
                turnover_max: document.getElementById('screenTurnoverMax').value || undefined,
                sort_by: document.getElementById('screenSortBy').value,
                sort_order: document.getElementById('screenSortOrder').value,
                page: page,
                page_size: 50
            };

            // è¿‡æ»¤æ‰undefinedçš„å‚æ•°
            currentScreenParams = Object.fromEntries(
                Object.entries(params).filter(([_, v]) => v !== undefined && v !== '')
            );
            currentScreenPage = page;

            document.getElementById('screenResultLoading').style.display = 'block';
            document.getElementById('screenResultTable').innerHTML = '';
            document.getElementById('screenPresetName').textContent = 'è‡ªå®šä¹‰ç­›é€‰';

            try {
                const queryString = new URLSearchParams(currentScreenParams).toString();
                const result = await apiCall(`/api/screener/filter?${queryString}`);

                if (result.success) {
                    renderScreenResult(result);
                } else {
                    document.getElementById('screenResultTable').innerHTML =
                        `<div style="text-align: center; color: var(--accent-red); padding: 2rem;">${result.error || 'ç­›é€‰å¤±è´¥'}</div>`;
                }
            } catch (error) {
                document.getElementById('screenResultTable').innerHTML =
                    `<div style="text-align: center; color: var(--accent-red); padding: 2rem;">ç­›é€‰å¤±è´¥: ${error.message}</div>`;
            } finally {
                document.getElementById('screenResultLoading').style.display = 'none';
            }
        }

        function renderScreenResult(result) {
            const stocks = result.stocks || [];
            const total = result.total || 0;

            document.getElementById('screenResultCount').textContent = `(å…± ${total} åª)`;

            if (stocks.length === 0) {
                document.getElementById('screenResultTable').innerHTML =
                    '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨</div>';
                document.getElementById('screenPagination').style.display = 'none';
                return;
            }

            const tableHtml = `
                <table class="data-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>ä»£ç </th>
                            <th>åç§°</th>
                            <th>ç°ä»·</th>
                            <th>æ¶¨è·Œå¹…</th>
                            <th>å¸‚å€¼(äº¿)</th>
                            <th>PE(TTM)</th>
                            <th>PB</th>
                            <th>æ¢æ‰‹ç‡</th>
                            <th>è¡Œä¸š</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stocks.map(s => `
                            <tr>
                                <td>${s.code}</td>
                                <td>${s.name}</td>
                                <td>${formatNumber(s.price)}</td>
                                <td class="${s.change_percent >= 0 ? 'text-green' : 'text-red'}">
                                    ${s.change_percent >= 0 ? '+' : ''}${formatNumber(s.change_percent)}%
                                </td>
                                <td>${formatBigNumber(s.market_cap)}</td>
                                <td>${formatNumber(s.pe_ttm)}</td>
                                <td>${formatNumber(s.pb)}</td>
                                <td>${formatNumber(s.turnover_rate)}%</td>
                                <td>${s.industry || '--'}</td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" onclick="addToWatchListFromScreen('${s.code}', '${s.name}')">+å…³æ³¨</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('screenResultTable').innerHTML = tableHtml;

            // æ¸²æŸ“åˆ†é¡µ
            if (result.total_pages > 1) {
                renderScreenPagination(result.page, result.total_pages);
            } else {
                document.getElementById('screenPagination').style.display = 'none';
            }
        }

        function renderScreenPagination(currentPage, totalPages) {
            const container = document.getElementById('screenPagination');
            container.style.display = 'flex';

            let html = '';

            // ä¸Šä¸€é¡µ
            if (currentPage > 1) {
                html += `<button class="btn btn-sm btn-secondary" onclick="customScreen(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            }

            // é¡µç 
            const start = Math.max(1, currentPage - 2);
            const end = Math.min(totalPages, currentPage + 2);

            for (let i = start; i <= end; i++) {
                if (i === currentPage) {
                    html += `<button class="btn btn-sm btn-primary">${i}</button>`;
                } else {
                    html += `<button class="btn btn-sm btn-secondary" onclick="customScreen(${i})">${i}</button>`;
                }
            }

            // ä¸‹ä¸€é¡µ
            if (currentPage < totalPages) {
                html += `<button class="btn btn-sm btn-secondary" onclick="customScreen(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            }

            container.innerHTML = html;
        }

        function clearScreenFilter() {
            document.getElementById('screenMarketCapMin').value = '';
            document.getElementById('screenMarketCapMax').value = '';
            document.getElementById('screenPeMin').value = '';
            document.getElementById('screenPeMax').value = '';
            document.getElementById('screenChangeMin').value = '';
            document.getElementById('screenChangeMax').value = '';
            document.getElementById('screenTurnoverMin').value = '';
            document.getElementById('screenTurnoverMax').value = '';
            document.getElementById('screenSortBy').value = 'market_cap';
            document.getElementById('screenSortOrder').value = 'desc';
        }

        async function addToWatchListFromScreen(code, name) {
            try {
                const result = await apiCall('/api/stocks/watch-list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, name })
                });

                if (result.success) {
                    alert(`å·²æ·»åŠ  ${name} åˆ°å…³æ³¨åˆ—è¡¨`);
                } else {
                    alert(result.message || 'æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
            }
        }

        // ============ ç¾è‚¡æ¨¡å— ============
        let usKlineChart = null;

        async function loadUSMarket() {
            try {
                const result = await apiCall('/api/us/overview');

                if (result.success && result.data) {
                    renderUSIndices(result.data.indices || []);
                    renderChinaADR(result.data.china_adr || []);
                    renderPopularUS(result.data.popular || []);
                }
            } catch (error) {
                console.error('åŠ è½½ç¾è‚¡å¸‚åœºå¤±è´¥:', error);
            }
        }

        function renderUSIndices(indices) {
            const container = document.getElementById('usIndicesGrid');
            if (!indices.length) {
                container.innerHTML = '<div style="color: var(--text-secondary);">æš‚æ— æ•°æ®</div>';
                return;
            }

            container.innerHTML = indices.map(idx => {
                const changeClass = idx.change_percent >= 0 ? 'green' : 'red';
                const changeSign = idx.change_percent >= 0 ? '+' : '';
                return `
                    <div class="stat-card ${changeClass}" style="cursor: pointer;" onclick="showUSDetail('${idx.symbol}')">
                        <div class="stat-label">${idx.name || idx.symbol}</div>
                        <div class="stat-value">${formatNumber(idx.price)}</div>
                        <div class="stat-change ${changeClass}">${changeSign}${formatNumber(idx.change_percent)}%</div>
                    </div>
                `;
            }).join('');
        }

        function renderChinaADR(stocks) {
            const container = document.getElementById('chinaAdrList');
            if (!stocks.length) {
                container.innerHTML = '<div style="color: var(--text-secondary);">æš‚æ— æ•°æ®</div>';
                return;
            }

            container.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${stocks.map(s => {
                        const changeClass = s.change_percent >= 0 ? 'text-green' : 'text-red';
                        const changeSign = s.change_percent >= 0 ? '+' : '';
                        return `
                            <div class="stock-chip" style="background: var(--bg-secondary); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;" onclick="showUSDetail('${s.symbol}')">
                                <span>${s.cn_name || s.name}</span>
                                <span style="margin-left: 0.5rem; font-size: 0.85rem;">${s.symbol}</span>
                                <span class="${changeClass}" style="margin-left: 0.5rem;">${changeSign}${formatNumber(s.change_percent)}%</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderPopularUS(stocks) {
            const container = document.getElementById('popularUSList');
            if (!stocks.length) {
                container.innerHTML = '<div style="color: var(--text-secondary);">æš‚æ— æ•°æ®</div>';
                return;
            }

            container.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${stocks.map(s => {
                        const changeClass = s.change_percent >= 0 ? 'text-green' : 'text-red';
                        const changeSign = s.change_percent >= 0 ? '+' : '';
                        return `
                            <div class="stock-chip" style="background: var(--bg-secondary); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;" onclick="showUSDetail('${s.symbol}')">
                                <span>${s.cn_name || s.name}</span>
                                <span style="margin-left: 0.5rem; font-size: 0.85rem;">${s.symbol}</span>
                                <span class="${changeClass}" style="margin-left: 0.5rem;">${changeSign}${formatNumber(s.change_percent)}%</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        async function searchUSStock() {
            const keyword = document.getElementById('usSearchInput').value.trim();
            if (!keyword) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }

            const container = document.getElementById('usSearchResults');
            container.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';

            try {
                const result = await apiCall(`/api/us/search?q=${encodeURIComponent(keyword)}`);

                if (result.success && result.data && result.data.length > 0) {
                    container.innerHTML = `
                        <table class="data-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>ä»£ç </th>
                                    <th>åç§°</th>
                                    <th>äº¤æ˜“æ‰€</th>
                                    <th>ç±»å‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.map(s => `
                                    <tr>
                                        <td>${s.symbol}</td>
                                        <td>${s.name}</td>
                                        <td>${s.exchange}</td>
                                        <td>${s.type}</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="showUSDetail('${s.symbol}')">æŸ¥çœ‹</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 1rem;">æœªæ‰¾åˆ°ç›¸å…³è‚¡ç¥¨</div>';
                }
            } catch (error) {
                container.innerHTML = `<div style="color: var(--accent-red); text-align: center; padding: 1rem;">æœç´¢å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function showUSDetail(symbol) {
            const detailEl = document.getElementById('usStockDetail');
            detailEl.style.display = 'block';

            // åŠ è½½è¡Œæƒ…
            try {
                const quoteResult = await apiCall(`/api/us/quote/${symbol}`);

                if (quoteResult.success && quoteResult.data) {
                    const q = quoteResult.data;
                    document.getElementById('usDetailName').textContent = q.name || symbol;
                    document.getElementById('usDetailSymbol').textContent = q.symbol;
                    document.getElementById('usDetailPrice').textContent = `$${formatNumber(q.price)}`;

                    const changeEl = document.getElementById('usDetailChange');
                    changeEl.textContent = `${q.change_percent >= 0 ? '+' : ''}${formatNumber(q.change_percent)}%`;
                    changeEl.className = 'stat-value ' + (q.change_percent >= 0 ? 'text-green' : 'text-red');

                    document.getElementById('usDetailMarketCap').textContent = formatUSMarketCap(q.market_cap);
                    document.getElementById('usDetailPE').textContent = formatNumber(q.pe_ratio);
                }

                // åŠ è½½Kçº¿
                const klineResult = await apiCall(`/api/us/kline/${symbol}?days=60`);

                if (klineResult.success && klineResult.data && klineResult.data.kline) {
                    renderUSKline(klineResult.data.kline);
                }
            } catch (error) {
                console.error('åŠ è½½ç¾è‚¡è¯¦æƒ…å¤±è´¥:', error);
            }

            // æ»šåŠ¨åˆ°è¯¦æƒ…åŒºåŸŸ
            detailEl.scrollIntoView({ behavior: 'smooth' });
        }

        function closeUSDetail() {
            document.getElementById('usStockDetail').style.display = 'none';
        }

        function renderUSKline(klineData) {
            if (!usKlineChart) {
                usKlineChart = echarts.init(document.getElementById('usKlineChart'));
            }

            usKlineChart.clear();

            const dates = klineData.map(k => k.date);
            const prices = klineData.map(k => k.close);

            usKlineChart.setOption({
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const data = params[0];
                        return `${data.name}<br/>æ”¶ç›˜ä»·: $${data.value}`;
                    }
                },
                grid: { left: 60, right: 20, top: 20, bottom: 30 },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: { color: '#a0a0a0' },
                    axisLine: { lineStyle: { color: '#2d2d5a' } }
                },
                yAxis: {
                    type: 'value',
                    axisLabel: { color: '#a0a0a0', formatter: '${value}' },
                    axisLine: { lineStyle: { color: '#2d2d5a' } },
                    splitLine: { lineStyle: { color: '#2d2d5a' } }
                },
                series: [{
                    type: 'line',
                    data: prices,
                    smooth: true,
                    lineStyle: { color: '#4facfe', width: 2 },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(79, 172, 254, 0.3)' },
                            { offset: 1, color: 'rgba(79, 172, 254, 0)' }
                        ])
                    },
                    itemStyle: { color: '#4facfe' }
                }]
            });
        }

        function formatUSMarketCap(value) {
            if (!value) return '--';
            if (value >= 1e12) return (value / 1e12).toFixed(2) + 'T';
            if (value >= 1e9) return (value / 1e9).toFixed(2) + 'B';
            if (value >= 1e6) return (value / 1e6).toFixed(2) + 'M';
            return value.toString();
        }

        // ============ ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ ============
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);

            // é‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥é€‚åº”æ–°ä¸»é¢˜
            resizeAllCharts();
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.textContent = theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
            }
        }

        function resizeAllCharts() {
            // è§¦å‘æ‰€æœ‰å›¾è¡¨çš„resizeï¼Œä»¥ä¾¿å®ƒä»¬é€‚åº”æ–°ä¸»é¢˜
            window.dispatchEvent(new Event('resize'));
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();  // åˆå§‹åŒ–ä¸»é¢˜
            refreshAll();
            // Auto refresh every 30 seconds
            setInterval(refreshAll, 30000);
        });
    </script>
</body>
</html>
